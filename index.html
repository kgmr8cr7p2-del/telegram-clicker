<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Clicker Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; background: #f7f9fc; }
    h1 { color: #222; }
    button { padding: 10px 20px; font-size: 18px; border-radius: 8px; border: none; background: #3390ec; color: white; cursor: pointer; margin: 10px; }
    #authMessage { color: #d63031; margin: 20px; padding: 20px; background: #ffeaa7; border-radius: 10px; }
    #game { display: none; }
  </style>
</head>
<body>
  <h1>🎮 Кликер игра</h1>
  
  <div id="authMessage">
    <h3>Запускайте игру через Telegram бота!</h3>
    <p>Эта игра работает только внутри Telegram.</p>
    <button onclick="simulateTelegram()">Тестовый режим (для разработки)</button>
  </div>
  
  <div id="game">
    <p id="user"></p>
    <p>Очки: <span id="score">0</span></p>
    <button id="clickBtn">Клик!</button>
    <button onclick="resetGame()">Сбросить игру</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const apiUrl = "https://script.google.com/macros/s/AKfycbzMW_6yKWD8txaOTW5dZUNCx5MAnNzCqQK97T3Yj6FFGKU6EimT_IuQp-r9rwk1-68D/exec";

    let player = {
      id: null,
      name: 'Гость',
      score: 0
    };

    function simulateTelegram() {
      player.id = Math.floor(Math.random() * 1000000);
      player.name = 'Тестовый пользователь';
      player.score = 0;
      
      document.getElementById('authMessage').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById("user").innerText = `Привет, ${player.name}! (Тестовый режим)`;
      document.getElementById("score").innerText = player.score;
    }

    function resetGame() {
      if (confirm('Сбросить все очки?')) {
        player.score = 0;
        document.getElementById("score").innerText = player.score;
        updateScore();
      }
    }

    function initTelegramGame() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        player.id = user.id;
        player.name = user.first_name || 'Игрок';
        
        tg.expand();
        document.getElementById('authMessage').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        
        loadPlayer();
      } else {
        console.log('Запуск вне Telegram');
      }
    }

    // Используем JSONP подход для обхода CORS
    function makeJSONPRequest(params, callback) {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      const script = document.createElement('script');
      
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(data);
      };
      
      const urlParams = new URLSearchParams(params).toString();
      script.src = apiUrl + '?' + urlParams + '&callback=' + callbackName;
      document.body.appendChild(script);
    }

    async function loadPlayer() {
      try {
        if (!player.id) return;
        
        const params = {
          action: "getPlayer",
          id: player.id,
          name: player.name
        };
        
        makeJSONPRequest(params, function(data) {
          if (data && data.score !== undefined) {
            player.score = data.score;
            document.getElementById("user").innerText = `Привет, ${player.name}!`;
            document.getElementById("score").innerText = player.score;
          }
        });
        
      } catch (error) {
        console.error('Ошибка загрузки:', error);
        document.getElementById("user").innerText = `Привет, ${player.name}!`;
        document.getElementById("score").innerText = player.score;
      }
    }

    function updateScore() {
      try {
        if (!player.id) return;
        
        const params = {
          action: "updateScore",
          id: player.id,
          score: player.score
        };
        
        // Создаем изображение для отправки GET запроса (обход CORS)
        const img = new Image();
        const urlParams = new URLSearchParams(params).toString();
        img.src = apiUrl + '?' + urlParams;
        
        console.log('Счет обновлен:', player.score);
      } catch (error) {
        console.log('Ошибка обновления счета:', error);
      }
    }

    // Альтернативный метод через iframe
    function updateScoreWithIframe() {
      if (!player.id) return;
      
      const params = {
        action: "updateScore",
        id: player.id,
        score: player.score
      };
      
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      const urlParams = new URLSearchParams(params).toString();
      iframe.src = apiUrl + '?' + urlParams;
      document.body.appendChild(iframe);
      
      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 1000);
    }

    // Обработчик клика
    document.getElementById("clickBtn").addEventListener("click", () => {
      player.score++;
      document.getElementById("score").innerText = player.score;
      updateScoreWithIframe(); // Используем iframe метод
    });

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', function() {
      initTelegramGame();
    });
  </script>
</body>
</html>