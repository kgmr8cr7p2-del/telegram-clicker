<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⛏️ Майнинг-Ферма</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Базовые стили для светлой темы (будут перезаписаны TG themeParams) */
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-secondary-bg-color: #f4f4f5;
            --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #fff;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 600px; margin: auto; }
        h1, h2, h3 { color: var(--tg-theme-text-color); }
        .balance {
            font-size: 1.5em; margin-bottom: 20px; padding: 10px;
            border: 1px solid var(--tg-theme-secondary-bg-color); border-radius: 10px;
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color); padding: 15px;
            margin-bottom: 10px; border-radius: 8px; display: flex;
            justify-content: space-between; align-items: center;
        }
        button {
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;
            margin-top: 10px; transition: opacity 0.2s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .shop-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: none; justify-content: center;
            align-items: center; z-index: 100;
        }
        .shop-content {
            background-color: var(--tg-theme-bg-color); padding: 20px;
            border-radius: 10px; max-width: 90%; max-height: 80%; overflow-y: auto;
        }
        .shop-item {
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color); padding: 10px 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .shop-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⛏️ Моя Ферма</h1>
        
        <div id="status">Инициализация...</div>
        
        <div class="balance">
            Баланс: <span id="money_balance">...</span> | 
            Крипта: <span id="crypto_balance">...</span>
        </div>
        
        <div id="farm_info">
            <h2>Общий хешрейт: <span id="total_hashrate">0</span> MH/s</h2>
            <h3>Текущая валюта: <span id="mining_currency">BTC</span></h3>
            <h3>Ваши слоты: <span id="slots_used">0</span>/<span id="slots_max">2</span></h3>
            <div id="cards_list"></div>
        </div>
        
        <button onclick="openShop()">🏪 Магазин Видеокарт</button>
        <button onclick="openMiningSettings()">⚙️ Сменить Валюту</button>
        <button onclick="loadFarmData(true)">🔄 Обновить (Майнинг)</button>
    </div>

    <div id="shop_modal" class="shop-modal" onclick="if(event.target.id === 'shop_modal') closeShop()">
        <div class="shop-content">
            <h2>🏪 Магазин</h2>
            <div id="shop_items">Загрузка товаров...</div>
            <button onclick="closeShop()">Закрыть</button>
        </div>
    </div>
    
    <script>
        const TG = window.Telegram.WebApp;
        
        // !!! ВАЖНО: Замените этот URL на URL развернутого скрипта Google Apps Script !!!
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxjOh8MypssAipH8EnycD7HHGe2n6TcuU1dO9jK-L3s1RPRUBCGrAqPBPSw5yyALWc7/exec'; 
        
        let userId;
        let userData = {};
        const isPopupSupported = TG.isVersionAtLeast('6.1');
        
        TG.ready();
        TG.expand(); 
        
        // 1. Инициализация и получение ID пользователя
        function initApp() {
            if (TG.initDataUnsafe.user) {
                userId = TG.initDataUnsafe.user.id;
            } else {
                userId = 'TEST_USER_456'; 
                document.getElementById('status').innerText += " (ТЕСТОВЫЙ РЕЖИМ)";
            }
            // Адаптация цветов темы Telegram
            if (TG.colorScheme === 'dark') {
                document.documentElement.style.setProperty('--tg-theme-bg-color', TG.themeParams.bg_color || '#1e2124');
                document.documentElement.style.setProperty('--tg-theme-text-color', TG.themeParams.text_color || '#fff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', TG.themeParams.secondary_bg_color || '#2d333a');
            } else {
                 document.documentElement.style.setProperty('--tg-theme-bg-color', TG.themeParams.bg_color || '#fff');
                document.documentElement.style.setProperty('--tg-theme-text-color', TG.themeParams.text_color || '#000');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', TG.themeParams.secondary_bg_color || '#f4f4f5');
            }

            loadFarmData();
        }

        // 2. Загрузка данных (включает расчет майнинга)
        async function loadFarmData(isManualUpdate = false) {
            document.getElementById('status').innerText = 'Загрузка данных...';
            
            try {
                const url = `${BACKEND_URL}?action=get_farm_data&user_id=${userId}&update_mining=${isManualUpdate ? 'true' : 'false'}`;
                const response = await fetch(url);
                userData = await response.json();

                if (userData.error) {
                    throw new Error(userData.error);
                }

                if (userData.is_new) {
                    startQuest();
                } else {
                    renderFarm(userData);
                    document.getElementById('status').innerText = isManualUpdate ? 'Ферма обновлена!' : 'Данные загружены.';
                }

            } catch (error) {
                document.getElementById('status').innerText = `Ошибка: ${error.message}. Проверьте URL бэкенда.`;
                console.error('Fetch error:', error);
            }
        }
        
        // 3. Отображение данных на странице
        function renderFarm(data) {
            document.getElementById('money_balance').innerText = `$${data.money.toFixed(2)}`;
            document.getElementById('crypto_balance').innerText = `${data.crypto.toFixed(5)} ${data.crypto_name}`;
            document.getElementById('total_hashrate').innerText = data.total_hashrate;
            document.getElementById('mining_currency').innerText = data.crypto_name;
            document.getElementById('slots_used').innerText = data.cards.length;
            document.getElementById('slots_max').innerText = data.slots_max;

            const cardsList = document.getElementById('cards_list');
            cardsList.innerHTML = data.cards.map(card => 
                `<div class="card">${card.name} (${card.hr} MH/s) <button onclick="sellCard('${card.instance_id}', ${card.price})">Продать (+$${(card.price * 0.5).toFixed(2)})</button></div>`
            ).join('');
        }

        // 4. Стартовый квест (Исправлено для совместимости v6.0)
        function startQuest() {
            if (isPopupSupported) {
                // Используем showPopup (для Telegram v6.1+)
                TG.showPopup({
                    title: '👋 Привет, Сынок!',
                    message: 'Отец: "Майнинг? Брось это, у тебя ничего не получится. Иди работать!"',
                    buttons: [{id: 'continue', text: 'Продолжить', type: 'default'}]
                }, (buttonId) => {
                    if (buttonId === 'continue') {
                        TG.showPopup({
                            title: '💰 Первая Находка',
                            message: 'Вы находите $500 под подушкой! Этого хватит на первую видеокарту.',
                            buttons: [{text: 'Начать играть!', type: 'ok'}]
                        }, () => {
                            loadFarmData(); 
                        });
                    }
                });
            } else {
                 // Используем alert/confirm (для старых версий Telegram)
                alert('👋 Привет, Сынок!\nОтец: "Майнинг? Брось это, у тебя ничего не получится. Иди работать!"');
                alert('💰 Первая Находка\nВы находите $500 под подушкой! Этого хватит на первую видеокарту.');
                loadFarmData(); // Продолжаем игру, предполагая, что бэкенд уже инициализировал $500
            }
        }

        // 5. Магазин
        async function openShop() {
            document.getElementById('shop_items').innerHTML = 'Загрузка товаров...';
            document.getElementById('shop_modal').style.display = 'flex';

            try {
                const url = `${BACKEND_URL}?action=get_store_data`;
                const response = await fetch(url);
                const storeData = await response.json();
                
                const shopItemsDiv = document.getElementById('shop_items');
                shopItemsDiv.innerHTML = storeData.map(item => `
                    <div class="shop-item">
                        <span>${item.name} (${item.hr} MH/s)</span>
                        <div>
                            $${item.price.toFixed(2)}
                            <button 
                                onclick="buyCard('${item.id}', ${item.price})"
                                ${userData.cards.length >= userData.slots_max || userData.money < item.price ? 'disabled' : ''}
                            >
                                Купить
                            </button>
                        </div>
                    </div>
                `).join('');

                if (userData.cards.length >= userData.slots_max) {
                    shopItemsDiv.innerHTML += '<p style="color: red;">Нет свободных слотов для карт!</p>';
                }

            } catch (error) {
                document.getElementById('shop_items').innerText = `Ошибка загрузки магазина: ${error.message}`;
            }
        }
        
        function closeShop() {
            document.getElementById('shop_modal').style.display = 'none';
        }

        // 6. Покупка карты (обновлена обработка ошибок)
        async function buyCard(cardId, price) {
             if (confirm(`Вы уверены, что хотите купить карту за $${price}?`)) {
                TG.showPopup({ title: 'Покупка', message: 'Обработка покупки...' });
                try {
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'buy_card', user_id: userId, card_id: cardId, price: price })
                    });
                    const result = await response.json();
                    
                    TG.closePopup();
                    if (result.success) {
                        TG.showAlert('Покупка успешна!');
                        closeShop();
                        loadFarmData();
                    } else {
                        // Выводит сообщение об ошибке, полученное из Google Apps Script
                        TG.showAlert('Ошибка покупки: ' + (result.error || 'Неизвестная ошибка.'));
                    }
                } catch (error) {
                    TG.closePopup();
                    TG.showAlert('Ошибка связи с сервером.');
                }
            }
        }

        // 7. Продажа карты
        async function sellCard(cardInstanceId, price) {
            const sellPrice = (price * 0.5).toFixed(2);
             if (confirm(`Вы уверены, что хотите продать эту карту за $${sellPrice}?`)) {
                TG.showPopup({ title: 'Продажа', message: 'Обработка продажи...' });
                try {
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'sell_card', user_id: userId, card_instance_id: cardInstanceId })
                    });
                    const result = await response.json();
                    
                    TG.closePopup();
                    if (result.success) {
                        TG.showAlert('Продажа успешна! Деньги начислены.');
                        loadFarmData();
                    } else {
                        TG.showAlert('Ошибка продажи: ' + (result.error || 'Неизвестная ошибка.'));
                    }
                } catch (error) {
                    TG.closePopup();
                    TG.showAlert('Ошибка связи с сервером.');
                }
            }
        }

        // 8. Смена валюты
        function openMiningSettings() {
            const newCurrency = prompt("Введите новую валюту для майнинга (BTC, ETH, DOGE):", userData.crypto_name);
            if (newCurrency) {
                 const upperCurrency = newCurrency.toUpperCase();
                 if (['BTC', 'ETH', 'DOGE'].includes(upperCurrency)) {
                    changeMiningCurrency(upperCurrency);
                } else {
                    TG.showAlert('Неизвестная валюта. Используйте BTC, ETH или DOGE.');
                }
            }
        }
        
        async function changeMiningCurrency(currency) {
            TG.showPopup({ title: 'Смена валюты', message: 'Обработка...' });
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'change_currency', user_id: userId, currency: currency })
                });
                const result = await response.json();
                
                TG.closePopup();
                if (result.success) {
                    TG.showAlert(`Вы успешно сменили валюту на ${currency}!`);
                    loadFarmData();
                } else {
                    TG.showAlert('Ошибка смены валюты: ' + (result.error || 'Неизвестная ошибка.'));
                }
            } catch (error) {
                TG.closePopup();
                TG.showAlert('Ошибка связи с сервером.');
            }
        }

        initApp();
    </script>
</body>
</html>