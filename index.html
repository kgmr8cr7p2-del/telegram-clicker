<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 24px; margin-bottom: 15px; }
        .stats { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 15px; backdrop-filter: blur(10px); margin-bottom: 10px; }
        .stats div { margin: 5px 0; font-size: 16px; }
        .game-area { text-align: center; margin: 20px 0; }
        .click-button { background: linear-gradient(45deg, #FF6B6B, #FFE66D); border: none; border-radius: 50%; width: 150px; height: 150px; font-size: 18px; font-weight: bold; color: #333; cursor: pointer; transition: all 0.2s; box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4); display: block; margin: 0 auto; touch-action: manipulation; user-select: none; }
        .click-button:active { transform: scale(0.95); }
        .click-button:disabled { background: #cccccc; cursor: not-allowed; }
        .energy-bar { width: 100%; height: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .energy-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00ccff); transition: width 0.3s; }
        .upgrades { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 15px; backdrop-filter: blur(10px); margin-bottom: 10px; }
        .upgrades h3 { margin-bottom: 10px; text-align: center; }
        .upgrade-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; cursor: pointer; font-size: 12px; transition: background 0.3s; }
        .upgrade-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .upgrade-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.3); }
        .leaderboard { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 15px; backdrop-filter: blur(10px); margin-bottom: 10px; }
        .leaderboard h3 { margin-bottom: 10px; text-align: center; }
        .leaderboard-item { padding: 10px 12px; margin: 5px 0; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }
        .cooldown { pointer-events: none; opacity: 0.7; }
        .tab-buttons { display: flex; margin-bottom: 10px; gap: 5px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; cursor: pointer; }
        .tab-btn.active { background: rgba(255, 255, 255, 0.4); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .autoclicker-info { font-size: 12px; opacity: 0.8; margin-top: 5px; }
        .leaderboard-stats { text-align: center; margin-top: 10px; font-size: 12px; opacity: 0.8; }
        .server-status { text-align: center; font-size: 12px; margin-top: 5px; padding: 5px; border-radius: 5px; }
        .status-online { background: rgba(76, 175, 80, 0.3); color: #90EE90; }
        .status-offline { background: rgba(244, 67, 54, 0.3); color: #FF6B6B; }
        .loading { text-align: center; padding: 20px; font-size: 16px; }
        .refresh-btn { background: rgba(255, 255, 255, 0.2); border: none; border-radius: 8px; color: white; padding: 8px 15px; margin-top: 10px; cursor: pointer; font-size: 12px; }
        .reset-btn { background: rgba(255, 100, 100, 0.3); border: none; border-radius: 8px; color: white; padding: 8px 15px; margin: 5px; cursor: pointer; font-size: 12px; }
        
        .offline-mode { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            margin: 20px 0; 
            text-align: center;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }
        .offline-warning { 
            color: #FF6B6B; 
            font-size: 14px; 
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .retry-button { 
            background: linear-gradient(45deg, #FF6B6B, #FF8E53); 
            border: none; 
            border-radius: 8px; 
            color: white; 
            padding: 10px 20px; 
            margin: 10px 0; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.3s;
        }
        .retry-button:hover { 
            transform: scale(1.05); 
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .energy-info { 
            font-size: 11px; 
            opacity: 0.7; 
            margin-top: 3px;
        }
        .last-sync { 
            font-size: 10px; 
            opacity: 0.5; 
            margin-top: 5px;
        }
        .dev-mode { 
            background: rgba(255, 215, 0, 0.2); 
            padding: 10px; 
            border-radius: 10px; 
            margin: 10px 0; 
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞... ‚è≥</div>
    </div>

    <script>
        // URL –≤–∞—à–µ–≥–æ Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbzGhuJLb5BlJwNxDTQw4dtQ17bCnYe-tWM_MUQn5oChUVEqGgUupv1CMnrUBAm8w93l/exec';

        let gameState;
        let autoclickerInterval;
        let energyInterval;
        let syncInterval;
        let lastServerSync = 0;

        function initTelegramApp() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App...');
            if (window.Telegram && Telegram.WebApp) {
                console.log('‚úÖ –í Telegram Web App');
                Telegram.WebApp.expand();
            }
            initGame();
        }

        function initGame() {
            console.log('üéÆ –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
            createGameInterface();
            
            // –ë–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            gameState = {
                coins: 0,
                level: 1,
                energy: 650,
                maxEnergy: 650,
                energyPerClick: 5,
                energyRegen: 1,
                lastEnergyUpdate: Date.now(),
                
                upgrades: {
                    clickPower: { level: 1, cost: 50 },
                    energyRegen: { level: 1, cost: 100 },
                    autoclicker: { level: 0, cost: 200 }
                },
                
                lastClickTime: 0,
                clickCooldown: 100,
                leaderboard: [],
                totalPlayers: 0,
                serverOnline: false,
                offlineMode: false
            };

            loadGameProgress();
        }

        function getUserId() {
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
                return 'tg_' + Telegram.WebApp.initDataUnsafe.user.id;
            }
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        function getPlayerName() {
            return window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫';
        }

        // üì• –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–ì–†–ï–°–°–ê —á–µ—Ä–µ–∑ XMLHttpRequest
        async function loadGameProgress() {
            try {
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...');
                showLoadingMessage('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É... üåê');
                
                const userId = getUserId();
                const playerName = getPlayerName();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º XMLHttpRequest –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                const data = await loadViaXHR('getPlayerData', {
                    userId: userId,
                    playerName: playerName
                });
                
                if (data && data.success) {
                    processServerData(data);
                    console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞');
                } else {
                    throw new Error(data ? data.error : 'No data from server');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                handleServerError();
            }
            
            updateUI();
            startGameFeatures();
        }

        // üîÑ XMLHttpRequest –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
        function loadViaXHR(action, params) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                let url = `${API_URL}?action=${action}&t=${Date.now()}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
                for (const key in params) {
                    if (params[key]) {
                        url += `&${key}=${encodeURIComponent(params[key])}`;
                    }
                }
                
                console.log('üì° XHR –∑–∞–ø—Ä–æ—Å:', url);
                
                xhr.open('GET', url, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                // –ï—Å–ª–∏ –Ω–µ JSON, –ø—Ä–æ–±—É–µ–º eval (–¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
                                try {
                                    const response = eval(`(${xhr.responseText})`);
                                    resolve(response);
                                } catch (e2) {
                                    reject(new Error('Invalid response format: ' + xhr.responseText));
                                }
                            }
                        } else {
                            reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                        }
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('Network error'));
                };
                
                xhr.timeout = 10000;
                xhr.ontimeout = function() {
                    reject(new Error('Request timeout'));
                };
                
                xhr.send();
            });
        }

        // üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï —á–µ—Ä–µ–∑ XMLHttpRequest
        function saveViaXHR(action, params) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                let url = `${API_URL}?action=${action}&t=${Date.now()}`;
                
                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–∞
                const formData = new FormData();
                formData.append('action', action);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                for (const key in params) {
                    if (params[key] !== undefined && params[key] !== null) {
                        if (typeof params[key] === 'object') {
                            formData.append(key, JSON.stringify(params[key]));
                        } else {
                            formData.append(key, params[key]);
                        }
                    }
                }
                
                console.log('üì° XHR —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:', action, params);
                
                xhr.open('POST', url, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                try {
                                    const response = eval(`(${xhr.responseText})`);
                                    resolve(response);
                                } catch (e2) {
                                    reject(new Error('Invalid response format: ' + xhr.responseText));
                                }
                            }
                        } else {
                            reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                        }
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('Network error'));
                };
                
                xhr.timeout = 10000;
                xhr.ontimeout = function() {
                    reject(new Error('Request timeout'));
                };
                
                xhr.send(formData);
            });
        }

        function processServerData(data) {
            gameState.leaderboard = data.leaders || [];
            gameState.totalPlayers = data.totalPlayers || 0;
            gameState.serverOnline = true;
            gameState.offlineMode = false;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞
            if (data.playerData) {
                const serverData = data.playerData;
                const energyCalc = calculateCurrentEnergy(
                    serverData.energy || 650,
                    serverData.lastEnergyUpdate || Date.now(),
                    serverData.energyRegen || 1,
                    serverData.maxEnergy || 650
                );
                
                gameState.coins = serverData.coins || 0;
                gameState.level = serverData.level || 1;
                gameState.energy = energyCalc.energy;
                gameState.maxEnergy = serverData.maxEnergy || 650;
                gameState.energyPerClick = serverData.energyPerClick || 5;
                gameState.energyRegen = serverData.energyRegen || 1;
                gameState.lastEnergyUpdate = energyCalc.lastUpdateTime;
                
                if (serverData.upgrades) {
                    gameState.upgrades = serverData.upgrades;
                }
            } else {
                // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
                createNewGame();
            }
            
            lastServerSync = Date.now();
            showNotification('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω! ‚úÖ');
        }

        function calculateCurrentEnergy(savedEnergy, lastUpdateTime, energyRegen, maxEnergy) {
            const now = Date.now();
            const timeDiff = Math.floor((now - lastUpdateTime) / 1000);
            const regeneratedEnergy = timeDiff * energyRegen;
            const newEnergy = Math.min(maxEnergy, savedEnergy + regeneratedEnergy);
            
            console.log(`‚ö° –†–∞—Å—á–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏: ${savedEnergy} + (${timeDiff}—Å–µ–∫ * ${energyRegen}/—Å–µ–∫) = ${newEnergy}`);
            return {
                energy: newEnergy,
                lastUpdateTime: now
            };
        }

        function handleServerError() {
            gameState.serverOnline = false;
            gameState.offlineMode = true;
            
            const localData = localStorage.getItem('telegram_clicker_backup');
            if (localData) {
                try {
                    const savedState = JSON.parse(localData);
                    const energyCalc = calculateCurrentEnergy(
                        savedState.energy || 650,
                        savedState.lastEnergyUpdate || Date.now(),
                        savedState.energyRegen || 1,
                        savedState.maxEnergy || 650
                    );
                    
                    gameState.coins = savedState.coins || 0;
                    gameState.level = savedState.level || 1;
                    gameState.energy = energyCalc.energy;
                    gameState.maxEnergy = savedState.maxEnergy || 650;
                    gameState.energyPerClick = savedState.energyPerClick || 5;
                    gameState.energyRegen = savedState.energyRegen || 1;
                    gameState.lastEnergyUpdate = energyCalc.lastUpdateTime;
                    
                    if (savedState.upgrades) {
                        gameState.upgrades = savedState.upgrades;
                    }
                    
                    console.log('üì± –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ localStorage');
                    showNotification('–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω üì±');
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', e);
                    createNewGame();
                }
            } else {
                createNewGame();
            }
        }

        function createNewGame() {
            gameState.coins = 100;
            gameState.level = 1;
            gameState.energy = 650;
            gameState.maxEnergy = 650;
            gameState.energyPerClick = 5;
            gameState.energyRegen = 1;
            gameState.lastEnergyUpdate = Date.now();
            
            console.log('üéÆ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∏–≥—Ä–∞');
            showNotification('–ù–æ–≤–∞—è –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! üéÆ');
        }

        // üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–û–ì–†–ï–°–°–ê
        async function saveFullProgress() {
            // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            const backupData = {
                coins: gameState.coins,
                level: gameState.level,
                energy: gameState.energy,
                maxEnergy: gameState.maxEnergy,
                energyPerClick: gameState.energyPerClick,
                energyRegen: gameState.energyRegen,
                lastEnergyUpdate: gameState.lastEnergyUpdate,
                upgrades: gameState.upgrades,
                lastSave: Date.now()
            };
            
            localStorage.setItem('telegram_clicker_backup', JSON.stringify(backupData));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω
            if (!gameState.serverOnline || gameState.offlineMode) {
                return false;
            }
            
            try {
                const playerData = {
                    coins: gameState.coins,
                    level: gameState.level,
                    energy: gameState.energy,
                    maxEnergy: gameState.maxEnergy,
                    energyPerClick: gameState.energyPerClick,
                    energyRegen: gameState.energyRegen,
                    lastEnergyUpdate: gameState.lastEnergyUpdate,
                    upgrades: gameState.upgrades
                };
                
                const result = await saveViaXHR('savePlayerData', {
                    userId: getUserId(),
                    playerName: getPlayerName(),
                    playerData: playerData,
                    score: gameState.coins
                });
                
                if (result && result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    if (result.leaders) {
                        gameState.leaderboard = result.leaders;
                    }
                    if (result.totalPlayers) {
                        gameState.totalPlayers = result.totalPlayers;
                    }
                    
                    lastServerSync = Date.now();
                    console.log('üíæ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
                    return true;
                } else {
                    throw new Error(result ? result.error : 'Save failed');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                gameState.serverOnline = false;
                return false;
            }
        }

        // ‚ö° –°–ò–°–¢–ï–ú–ê –≠–ù–ï–†–ì–ò–ò
        function startEnergySystem() {
            if (energyInterval) clearInterval(energyInterval);
            
            energyInterval = setInterval(() => {
                const now = Date.now();
                const timeDiff = Math.floor((now - gameState.lastEnergyUpdate) / 1000);
                
                if (timeDiff > 0 && gameState.energy < gameState.maxEnergy) {
                    const regeneratedEnergy = timeDiff * gameState.energyRegen;
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + regeneratedEnergy);
                    gameState.lastEnergyUpdate = now;
                    
                    updateEnergyBar();
                    updateUI();
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                    if (now - lastServerSync > 30000 && gameState.serverOnline) {
                        saveFullProgress();
                    }
                }
            }, 1000);
        }

        function updateEnergyBar() {
            const energyFill = document.getElementById('energy-fill');
            if (energyFill) {
                const percentage = (gameState.energy / gameState.maxEnergy) * 100;
                energyFill.style.width = percentage + '%';
            }
        }

        function canClick() {
            return gameState.energy >= gameState.energyPerClick;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                z-index: 1000;
                font-size: 14px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function showLoadingMessage(message) {
            const loadingElement = document.querySelector('.loading');
            if (loadingElement) {
                loadingElement.innerHTML = message;
            }
        }

        function handleClick(event) {
            if (!canClick()) return;
            
            const now = Date.now();
            const timeSinceLastClick = now - gameState.lastClickTime;
            if (timeSinceLastClick < gameState.clickCooldown) return;
            
            gameState.lastClickTime = now;
            
            // –¢—Ä–∞—Ç–∏–º —ç–Ω–µ—Ä–≥–∏—é
            gameState.energy -= gameState.energyPerClick;
            gameState.lastEnergyUpdate = now;
            
            // –ü–æ–ª—É—á–∞–µ–º –º–æ–Ω–µ—Ç—ã
            const coinsEarned = gameState.upgrades.clickPower.level;
            gameState.coins += coinsEarned;
            
            if (gameState.coins >= gameState.level * 100) {
                gameState.level++;
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            saveFullProgress();
            updateUI();
            
            const clickButton = document.getElementById('click-btn');
            if (clickButton) {
                clickButton.style.transform = 'scale(0.95)';
                setTimeout(() => clickButton.style.transform = 'scale(1)', 100);
                clickButton.classList.add('cooldown');
                setTimeout(() => clickButton.classList.remove('cooldown'), gameState.clickCooldown);
            }
        }

        function startAutoclicker() {
            if (autoclickerInterval) clearInterval(autoclickerInterval);
            
            if (gameState.upgrades.autoclicker.level > 0) {
                autoclickerInterval = setInterval(() => {
                    if (canClick()) {
                        const now = Date.now();
                        
                        // –¢—Ä–∞—Ç–∏–º —ç–Ω–µ—Ä–≥–∏—é
                        gameState.energy -= gameState.energyPerClick;
                        gameState.lastEnergyUpdate = now;
                        
                        // –ü–æ–ª—É—á–∞–µ–º –º–æ–Ω–µ—Ç—ã
                        const autoCoins = gameState.upgrades.autoclicker.level * gameState.upgrades.clickPower.level;
                        gameState.coins += autoCoins;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –≤ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º–µ
                        if (now - lastServerSync > 10000 && gameState.serverOnline) {
                            saveFullProgress();
                        }
                        
                        updateUI();
                    }
                }, 1000);
            }
        }

        function updateUpgradeButtons() {
            const clickBtn = document.getElementById('upgrade-click-power');
            if (clickBtn) {
                const cost = gameState.upgrades.clickPower.cost;
                clickBtn.disabled = gameState.coins < cost;
                clickBtn.innerHTML = `üí™ +1 –º–æ–Ω–µ—Ç–∞ –∑–∞ –∫–ª–∏–∫<br><small>–£—Ä–æ–≤–µ–Ω—å: ${gameState.upgrades.clickPower.level} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost}</small>`;
            }
            
            const energyBtn = document.getElementById('upgrade-energy-regen');
            if (energyBtn) {
                const cost = gameState.upgrades.energyRegen.cost;
                energyBtn.disabled = gameState.coins < cost;
                energyBtn.innerHTML = `‚ö° +1 —ç–Ω–µ—Ä–≥–∏—è/—Å–µ–∫<br><small>–£—Ä–æ–≤–µ–Ω—å: ${gameState.upgrades.energyRegen.level} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost}</small>`;
            }
            
            const autoBtn = document.getElementById('upgrade-autoclicker');
            if (autoBtn) {
                const cost = gameState.upgrades.autoclicker.cost;
                autoBtn.disabled = gameState.coins < cost;
                autoBtn.innerHTML = `ü§ñ +1 –∞–≤—Ç–æ-–∫–ª–∏–∫/—Å–µ–∫<br><small>–£—Ä–æ–≤–µ–Ω—å: ${gameState.upgrades.autoclicker.level} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost}</small>`;
            }
        }

        function setupUpgrades() {
            document.getElementById('upgrade-click-power')?.addEventListener('click', function() {
                const upgrade = gameState.upgrades.clickPower;
                if (gameState.coins >= upgrade.cost) {
                    gameState.coins -= upgrade.cost;
                    upgrade.level += 1;
                    upgrade.cost *= 2;
                    
                    saveFullProgress();
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    }
                    updateUI();
                    showNotification(`üí™ –£–ª—É—á—à–µ–Ω–æ! –¢–µ–ø–µ—Ä—å +${upgrade.level} –º–æ–Ω–µ—Ç –∑–∞ –∫–ª–∏–∫`);
                }
            });

            document.getElementById('upgrade-energy-regen')?.addEventListener('click', function() {
                const upgrade = gameState.upgrades.energyRegen;
                if (gameState.coins >= upgrade.cost) {
                    gameState.coins -= upgrade.cost;
                    upgrade.level += 1;
                    gameState.energyRegen = upgrade.level;
                    upgrade.cost *= 2;
                    
                    saveFullProgress();
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    }
                    updateUI();
                    showNotification(`‚ö° –£–ª—É—á—à–µ–Ω–æ! –¢–µ–ø–µ—Ä—å +${upgrade.level} —ç–Ω–µ—Ä–≥–∏–∏/—Å–µ–∫`);
                }
            });

            document.getElementById('upgrade-autoclicker')?.addEventListener('click', function() {
                const upgrade = gameState.upgrades.autoclicker;
                if (gameState.coins >= upgrade.cost) {
                    gameState.coins -= upgrade.cost;
                    upgrade.level += 1;
                    upgrade.cost *= 2;
                    
                    startAutoclicker();
                    saveFullProgress();
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    }
                    updateUI();
                    showNotification(`ü§ñ –£–ª—É—á—à–µ–Ω–æ! –¢–µ–ø–µ—Ä—å +${upgrade.level} –∞–≤—Ç–æ-–∫–ª–∏–∫/—Å–µ–∫`);
                }
            });
        }

        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard-list');
            
            if (leaderboardList) {
                const currentPlayerName = getPlayerName();
                
                if (gameState.offlineMode) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #FFE66D;">
                            üì± –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º<br>
                            <small>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</small>
                        </div>
                    `;
                } else if (!gameState.serverOnline) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #FF6B6B;">
                            üî¥ –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω<br>
                            <small>–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</small>
                        </div>
                    `;
                } else if (gameState.leaderboard.length === 0) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –ø—É—Å—Ç–∞!<br>
                            <small>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º –∏–≥—Ä–æ–∫–æ–º!</small>
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = gameState.leaderboard.map((player, index) => {
                        const isCurrentPlayer = (player.name === currentPlayerName);
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                        const date = player.date ? new Date(player.date).toLocaleDateString('ru-RU') : '';
                        
                        return `
                            <div class="leaderboard-item" style="${isCurrentPlayer ? 'background: linear-gradient(90deg, rgba(255,215,0,0.3) 0%, rgba(255,215,0,0.1) 100%); border-left: 4px solid gold;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: ${isCurrentPlayer ? 'bold' : 'normal'}; font-size: 14px;">
                                            ${medal} ${player.name} 
                                            ${isCurrentPlayer ? ' <span style="color: gold;">(–í—ã) üëë</span>' : ''}
                                        </div>
                                        <div style="font-size: 10px; opacity: 0.7; margin-top: 2px;">${date}</div>
                                    </div>
                                    <div style="font-weight: bold; font-size: 16px; color: #FFE66D; margin-left: 10px;">
                                        ${player.score.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            const statsElement = document.getElementById('leaderboard-stats');
            if (statsElement) {
                if (gameState.serverOnline) {
                    statsElement.innerHTML = `–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: ${gameState.totalPlayers} üéÆ`;
                } else if (gameState.offlineMode) {
                    statsElement.innerHTML = `–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º üì±`;
                } else {
                    statsElement.innerHTML = `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É... üîÑ`;
                }
            }
        }

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    const tabName = button.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
        }

        function resetGame() {
            if (confirm('üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É?\n–í—Å–µ –≤–∞—à–∏ –º–æ–Ω–µ—Ç—ã –∏ —É–ª—É—á—à–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                gameState = {
                    coins: 0,
                    level: 1,
                    energy: 650,
                    maxEnergy: 650,
                    energyPerClick: 5,
                    energyRegen: 1,
                    lastEnergyUpdate: Date.now(),
                    upgrades: {
                        clickPower: { level: 1, cost: 50 },
                        energyRegen: { level: 1, cost: 100 },
                        autoclicker: { level: 0, cost: 200 }
                    },
                    lastClickTime: 0,
                    clickCooldown: 100,
                    leaderboard: [],
                    totalPlayers: 0,
                    serverOnline: false,
                    offlineMode: false
                };
                
                if (autoclickerInterval) clearInterval(autoclickerInterval);
                if (energyInterval) clearInterval(energyInterval);
                if (syncInterval) clearInterval(syncInterval);
                
                localStorage.removeItem('telegram_clicker_backup');
                updateUI();
                loadGameProgress();
                startEnergySystem();
                showNotification('–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞! ‚úÖ');
            }
        }

        function retryConnection() {
            gameState.offlineMode = false;
            showLoadingMessage('–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É... üîÑ');
            loadGameProgress();
        }

        function createGameInterface() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>üéÆ –≠–Ω–µ—Ä–≥–æ-–ö–ª–∏–∫–µ—Ä</h1>
                        <div class="stats">
                            <div>–ú–æ–Ω–µ—Ç—ã: <span id="coins">0</span></div>
                            <div>–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span></div>
                            <div>–≠–Ω–µ—Ä–≥–∏—è: <span id="energy">650/650</span></div>
                            <div>–ó–∞ –∫–ª–∏–∫: <span id="click-power">+1 –º–æ–Ω–µ—Ç</span></div>
                            <div id="autoclicker-info" class="autoclicker-info">–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä: +0 –º–æ–Ω–µ—Ç/—Å–µ–∫</div>
                            <div class="energy-info">‚ö° –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è: <span id="energy-regen">1</span>/—Å–µ–∫</div>
                            <div id="server-status" class="server-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
                            <div id="last-sync" class="last-sync"></div>
                        </div>
                    </div>

                    <div id="offline-mode" class="offline-mode" style="display: none;">
                        <div class="offline-warning">
                            ‚ö†Ô∏è –õ–û–ö–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú
                        </div>
                        <div style="font-size: 14px; margin: 10px 0;">
                            –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                        </div>
                        <button class="retry-button" onclick="retryConnection()">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                        </button>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
                            –≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –æ—Ñ–ª–∞–π–Ω!
                        </div>
                    </div>

                    <div class="game-area">
                        <button id="click-btn" class="click-button">‚ö° –ö–õ–ò–ö!<br><small>(-5 —ç–Ω–µ—Ä–≥–∏–∏)</small></button>
                        <div class="energy-bar">
                            <div id="energy-fill" class="energy-fill"></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <button class="reset-btn" onclick="resetGame()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</button>
                        </div>
                    </div>

                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="upgrades">–£–ª—É—á—à–µ–Ω–∏—è</button>
                        <button class="tab-btn" data-tab="leaderboard">–õ–∏–¥–µ—Ä—ã</button>
                    </div>

                    <div id="upgrades-tab" class="tab-content active">
                        <div class="upgrades">
                            <h3>‚ö° –£–ª—É—á—à–µ–Ω–∏—è</h3>
                            <button class="upgrade-btn" id="upgrade-click-power">
                                üí™ +1 –º–æ–Ω–µ—Ç–∞ –∑–∞ –∫–ª–∏–∫<br>
                                <small>–£—Ä–æ–≤–µ–Ω—å: 1 | –°—Ç–æ–∏–º–æ—Å—Ç—å: 50</small>
                            </button>
                            <button class="upgrade-btn" id="upgrade-energy-regen">
                                ‚ö° +1 —ç–Ω–µ—Ä–≥–∏—è/—Å–µ–∫<br>
                                <small>–£—Ä–æ–≤–µ–Ω—å: 1 | –°—Ç–æ–∏–º–æ—Å—Ç—å: 100</small>
                            </button>
                            <button class="upgrade-btn" id="upgrade-autoclicker">
                                ü§ñ +1 –∞–≤—Ç–æ-–∫–ª–∏–∫/—Å–µ–∫<br>
                                <small>–£—Ä–æ–≤–µ–Ω—å: 0 | –°—Ç–æ–∏–º–æ—Å—Ç—å: 200</small>
                            </button>
                        </div>
                    </div>

                    <div id="leaderboard-tab" class="tab-content">
                        <div class="leaderboard">
                            <h3>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h3>
                            <div id="leaderboard-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã... ‚è≥</div>
                            <div id="leaderboard-stats" class="leaderboard-stats"></div>
                            <button class="refresh-btn" onclick="loadGameProgress()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateUI() {
            const coinsElement = document.getElementById('coins');
            const levelElement = document.getElementById('level');
            const energyElement = document.getElementById('energy');
            const clickPowerElement = document.getElementById('click-power');
            const energyRegenElement = document.getElementById('energy-regen');
            const autoclickerInfo = document.getElementById('autoclicker-info');
            const serverStatus = document.getElementById('server-status');
            const offlineModeElement = document.getElementById('offline-mode');
            const lastSyncElement = document.getElementById('last-sync');
            
            if (coinsElement) coinsElement.textContent = gameState.coins.toLocaleString();
            if (levelElement) levelElement.textContent = gameState.level;
            if (energyElement) energyElement.textContent = `${Math.floor(gameState.energy)}/${gameState.maxEnergy}`;
            if (clickPowerElement) clickPowerElement.textContent = `+${gameState.upgrades.clickPower.level} –º–æ–Ω–µ—Ç`;
            if (energyRegenElement) energyRegenElement.textContent = `${gameState.energyRegen}/—Å–µ–∫`;
            
            if (autoclickerInfo) {
                const autoCoins = gameState.upgrades.autoclicker.level * gameState.upgrades.clickPower.level;
                autoclickerInfo.textContent = `–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä: +${autoCoins} –º–æ–Ω–µ—Ç/—Å–µ–∫`;
            }
            
            if (serverStatus) {
                if (gameState.serverOnline) {
                    serverStatus.textContent = 'üü¢ –°–µ—Ä–≤–µ—Ä –æ–Ω–ª–∞–π–Ω';
                    serverStatus.className = 'server-status status-online';
                } else if (gameState.offlineMode) {
                    serverStatus.textContent = 'üü° –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º';
                    serverStatus.className = 'server-status status-offline';
                } else {
                    serverStatus.textContent = 'üî¥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    serverStatus.className = 'server-status status-offline';
                }
            }
            
            if (lastSyncElement) {
                if (gameState.serverOnline && lastServerSync > 0) {
                    const syncAgo = Math.floor((Date.now() - lastServerSync) / 1000);
                    lastSyncElement.textContent = `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${syncAgo} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
                } else if (gameState.offlineMode) {
                    lastSyncElement.textContent = '–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ';
                } else {
                    lastSyncElement.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...';
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º
            if (offlineModeElement) {
                offlineModeElement.style.display = gameState.offlineMode ? 'block' : 'none';
            }
            
            updateUpgradeButtons();
            updateEnergyBar();
            updateLeaderboard();
            
            const clickButton = document.getElementById('click-btn');
            if (clickButton) {
                clickButton.disabled = !canClick();
            }
        }

        function startGameFeatures() {
            startEnergySystem();
            startAutoclicker();
            setupUpgrades();
            setupTabs();
            
            const clickButton = document.getElementById('click-btn');
            if (clickButton) {
                clickButton.addEventListener('click', handleClick);
                clickButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleClick(e);
                });
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            syncInterval = setInterval(() => {
                if (gameState.serverOnline) {
                    saveFullProgress();
                }
            }, 60000);
            
            // –°–¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
            window.loadGameProgress = loadGameProgress;
            window.resetGame = resetGame;
            window.retryConnection = retryConnection;
            
            console.log('‚úÖ –ò–≥—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—É—â–µ–Ω–∞');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            initTelegramApp();
        });
    </script>
</body>
</html>