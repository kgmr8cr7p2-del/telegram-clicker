<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Case Drop Clicker V10</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #1b1b1b;
      --card-bg: #262626;
      --accent: #d4af37;
      --text: #e1e1e1;
      --progress-bg: #111;
      --progress-fill: #4caf50;
      
      /* Цвета редкости */
      --gray: #b0c3d9; --blue: #4b69ff; --purple: #8847ff; 
      --pink: #d32ce6; --red: #eb4b4b; --gold: #ffd700;   
    }
    
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text);
      margin: 0; padding: 0;
      user-select: none; 
      -webkit-user-select: none; 
      -moz-user-select: none; 
      -ms-user-select: none;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      overflow-y: auto;
    }
    
    .app-container {
      width: 100%;
      max-width: 450px;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #333;
      margin-bottom: 10px;
    }
    
    .balance {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent);
    }
    
    .stats {
      font-size: 12px;
      text-align: right;
      color: #aaa;
    }
    
    .click-area {
      text-align: center;
      margin: 20px 0;
    }
    
    .click-btn {
      width: 150px;
      height: 150px;
      background-color: var(--card-bg);
      border: 5px solid var(--accent);
      border-radius: 50%;
      font-size: 30px;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.1s ease-out;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 0 auto;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    }
    
    .click-btn:active {
      transform: scale(0.95);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 20px 0 10px;
    }
    
    .upgrade-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .btn {
      padding: 12px;
      background-color: var(--card-bg);
      color: var(--text);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background-color 0.2s;
      text-align: center;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    
    .btn:active {
      background-color: #383838;
    }
    
    .btn-buy {
      background-color: var(--accent);
      color: var(--bg-color);
    }
    
    .drop-progress {
      background-color: var(--progress-bg);
      border-radius: 6px;
      height: 12px;
      margin-top: 5px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background-color: var(--progress-fill);
      transition: width 0.3s ease-out;
    }
    
    .drop-zone {
      margin-top: 15px;
      padding: 15px;
      border: 2px dashed #444;
      border-radius: 10px;
      text-align: center;
      transition: border-color 0.3s;
    }

    .drop-zone.active {
        border-color: var(--accent);
        border-style: solid;
        background-color: #33333330;
    }

    .case-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    .case-img {
        width: 80px;
        height: 60px;
        object-fit: contain;
    }
    .btn-key {
        padding: 10px 20px;
        background-color: #4b69ff; /* Blue for key button */
        color: white;
    }

    /* --- MODAL STYLES --- */
    .full-screen-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }

    .modal-header {
      width: 100%;
      max-width: 450px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 10px;
      background: #111;
      position: sticky;
      top: 0;
      z-index: 1010;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
      padding: 5px;
    }

    /* Inventory */
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 10px;
      width: 100%;
      max-width: 450px;
    }
    
    .inv-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      border-top: 5px solid; /* For rarity color */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      height: 100%;
    }
    .inv-card img {
      width: 100%;
      max-height: 50px;
      object-fit: contain;
      margin-bottom: 5px;
    }
    .inv-sell-btn {
      width: 100%;
      background: #555;
      color: var(--text);
      border: none;
      padding: 5px 0;
      border-radius: 5px;
      margin-top: 5px;
      cursor: pointer;
    }

    /* Drop Modal */
    #dropModal .modal-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 80%;
      max-width: 300px;
    }

    .drop-info img {
      width: 100%;
      max-width: 150px;
      object-fit: contain;
      margin: 10px 0;
    }
    .drop-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .drop-buttons .btn {
      flex: 1;
    }

    /* Roulette */
    #rouletteScreen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .roulette-track {
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    .strip {
      display: flex;
      white-space: nowrap;
      padding: 20px 0;
      position: relative;
    }

    .roulette-item {
      width: 120px;
      height: 100px;
      background: #333;
      border-radius: 8px;
      margin-right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .roulette-item img {
      width: 80px;
      height: 60px;
      object-fit: contain;
    }
    
    .rarity-stripe {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    .indicator {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 3px;
      background: var(--accent);
      z-index: 5;
      transform: translateX(-50%);
    }

    /* Notification */
    #notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1001;
        font-size: 14px;
        white-space: nowrap;
        display: none;
    }
    
    /* Case Store Styles */
    .case-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--card-bg);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
    }
    .case-list-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .case-list-info img {
        width: 50px;
        height: 40px;
        object-fit: contain;
    }
    .case-details-btn {
        background: #555;
        color: var(--text);
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    /* Case Details Modal */
    #caseDetailsModal {
        background: rgba(0, 0, 0, 0.98);
        overflow-y: auto;
    }
    #caseDetailsContent {
        padding: 15px;
        width: 100%;
        max-width: 450px;
    }
    .details-item-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
    }
    .details-item-card {
        background: #2a2a2a;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        border-top: 5px solid;
    }
    .details-item-card img {
        width: 100%;
        max-height: 40px;
        object-fit: contain;
        margin-bottom: 5px;
    }
    .details-item-rarity {
        font-size: 9px;
        color: #aaa;
        margin-top: 3px;
    }

    /* Crafting Selection Styles */
    .craftable-item {
        cursor: pointer;
        transition: transform 0.1s;
    }
    .craftable-item.selected-for-craft {
        border-top-width: 8px;
        transform: scale(0.98);
    }
    .selection-overlay {
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        background: rgba(212, 175, 55, 0.5); /* Semi-transparent accent color */
        display: none; 
        align-items: center; 
        justify-content: center; 
        font-size: 24px; 
        color: white;
        border-radius: 8px;
        font-weight: bold;
    }

  </style>
</head>
<body>

<div class="app-container">
  
  <div class="header">
    <div class="balance" id="balanceDisp">0$</div>
    <div class="stats">
      Клик: <span id="clickDisp">+1</span><br>
      Авто: <span id="autoDisp">0</span>/с
    </div>
  </div>
  
  <div class="click-area">
    <button class="click-btn" onclick="handleClick()">
      КЛИК
      <span style="font-size: 14px; color: #aaa;">+<span id="clickDisp2">1</span></span>
    </button>
  </div>

  <div class="drop-section">
    <div class="section-title">След. дроп кейса</div>
    <div class="drop-progress">
        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
    </div>
    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">
        Кликов до дропа: <span id="clicksToDrop">5</span>
    </div>
    <div class="drop-zone" id="dropZone">
        <div style="color: #666; font-size: 14px;">Пусто... Кликай (0/5)</div>
    </div>
  </div>

  <div class="upgrade-section">
    <div class="section-title">Улучшения</div>
    <div class="upgrade-grid">
      <button class="btn btn-buy" onclick="buyUpgrade('click')">
        UPGRADE КЛИКА
        <span id="costClick">50$</span>
      </button>
      <button class="btn btn-buy" onclick="buyUpgrade('auto')">
        UPGRADE АВТО
        <span id="costAuto">100$</span>
      </button>
    </div>
  </div>
  
  <div class="menu-section">
    <div class="section-title">Меню</div>
    <div class="menu-grid">
      <button class="btn" onclick="toggleCaseStore(true)">
        📦 МАГАЗИН КЕЙСОВ
      </button>
      <button class="btn" onclick="toggleInventory(true)" style="flex-direction: row;
      justify-content: center; gap: 5px;">
        🎒 ИНВЕНТАРЬ (<span id="invCount">0</span>)
      </button>
      <button class="btn" onclick="toggleCrafting(true)">
        🛠️ КРАФТ
      </button>
    </div>
  </div>
  
</div>

<div id="rouletteScreen" class="full-screen-modal">
    <div class="indicator"></div>
    <div class="roulette-track">
        <div class="strip" id="strip"></div>
    </div>
</div>

<div id="dropModal" class="full-screen-modal" style="justify-content: center;">
    <div class="modal-content">
        <h3 id="dName" style="margin-top: 0;">Предмет</h3>
        <div class="drop-info">
            <img id="dImg" src="">
            <p id="dWear" style="font-size: 12px; color: #aaa; margin: 5px 0;"></p>
            <h4 id="dPrice">0$</h4>
        </div>
        <div class="drop-buttons">
            <button class="btn" onclick="sellDrop()">Продать</button>
            <button class="btn btn-buy" onclick="keepDrop()">Оставить</button>
        </div>
    </div>
</div>

<div id="inventoryScreen" class="full-screen-modal">
  <div class="modal-header">
    <span class="modal-title">🎒 Инвентарь</span>
    <button class="modal-close" onclick="toggleInventory(false)">&times;</button>
  </div>
  <div id="inventoryGrid" class="inventory-grid">
    </div>
</div>

<div id="caseStoreScreen" class="full-screen-modal">
    <div class="modal-header">
      <span class="modal-title">📦 Магазин Кейсов</span>
      <button class="modal-close" onclick="toggleCaseStore(false)">&times;</button>
    </div>
    <div id="caseStoreContent" class="app-container" style="padding: 15px;">
      </div>
</div>

<div id="caseDetailsModal" class="full-screen-modal" style="display: none;">
    <div class="modal-header">
        <span id="caseDetailsTitle" class="modal-title">Содержимое Кейса</span>
        <button class="modal-close" onclick="hideCaseDetails()">&times;</button>
    </div>
    <div id="caseDetailsContent" class="app-container" style="padding-top: 0;">
        </div>
</div>

<div id="craftingRaritySelectScreen" class="full-screen-modal">
    <div class="modal-header">
      <span class="modal-title">🛠️ Система Крафтов</span>
      <button class="modal-close" onclick="toggleCrafting(false)">&times;</button>
    </div>
    <div id="craftingRarityContent" class="app-container" style="padding: 15px;">
      </div>
</div>

<div id="craftingItemSelectScreen" class="full-screen-modal">
    <div class="modal-header" style="flex-direction: column; align-items: flex-start;">
      <span id="craftItemSelectTitle" class="modal-title" style="margin-bottom: 5px;">Выберите 10 предметов</span>
      <div style="font-size: 12px; color: #aaa;">Выбрано: <span id="craftSelectionCount">0</span>/10</div>
    </div>
    <div id="craftingSelectedItemGrid" class="inventory-grid">
      </div>
    <div style="padding: 15px; border-top: 1px solid #333; display: flex; justify-content: space-around; width: 100%; max-width: 450px; position: sticky; bottom: 0; background: #111; z-index: 1010;">
      <button class="btn" style="width: 100%; background: #444; margin-right: 10px;" onclick="hideCraftingItemSelect()">Отмена</button>
      <button id="finalizeCraftBtn" class="btn btn-buy" style="width: 100%;" disabled onclick="finalizeCraft()">Скрафтить</button>
    </div>
</div>

<div id="notification"></div>


<script>
  // !!! ВСТАВЬТЕ СЮДА ВАШ URL ГУГЛ СКРИПТА !!!
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzF8GaHJzOJy5Bqr0dHoz2TNvrV-tUbAC8N5cBfGXvXtfxLkB-IRUoEjjfT5MTAZh6a/exec'; 

  const DROP_THRESHOLD = 5; // Сколько кликов нужно для кейса

  // =========================================================================
  // --- НАСТРОЙКА ШАНСОВ ВЫПАДЕНИЯ (ФИКСИРОВАННЫЕ ВЕСА) ---
  // =========================================================================
  const RARITY_CHANCES = {
      // 49.00%
      gray:   { weight: 49000, color: '#b0c3d9', label: 'Common (49.00%)' }, 
      // 30.00%
      blue:   { weight: 30000, color: '#4b69ff', label: 'Rare (30.00%)' },
      // 15.00%
      purple: { weight: 15000, color: '#8847ff', label: 'Mythical (15.00%)' },
      // 4.50%
      pink:   { weight: 4500,  color: '#d32ce6', label: 'Legendary (4.50%)' },
      // 1.45%
      red:    { weight: 1450,  color: '#eb4b4b', label: 'Ancient (1.45%)' },
      // 0.05%
      gold:   { weight: 50,     color: '#ffd700', label: 'Extraordinary (0.05%)' }
  };
  const RARITY_COLORS = { 
      gray: RARITY_CHANCES.gray.color, blue: RARITY_CHANCES.blue.color, purple: RARITY_CHANCES.purple.color, 
      pink: RARITY_CHANCES.pink.color, red: RARITY_CHANCES.red.color, gold: RARITY_CHANCES.gold.color 
  };
  const TOTAL_WEIGHT = 100000; // Сумма всех весов
  const RARITY_ORDER = ['gray', 'blue', 'purple', 'pink', 'red', 'gold']; // Порядок редкостей (от худшего к лучшему)
  // =========================================================================

  // 1. БАЗА КЕЙСОВ И ПРЕДМЕТОВ (ВСЁ В ОДНОМ МЕСТЕ)
  const CASES = [
    {
      id: "case_common", 
      name: "Обычный Кейс", 
      keyPrice: 50, 
      image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/CS%20GO%20Weapon%20Case.png?raw=true",
      
      // Items - Группировка предметов по редкости
      items: {
          gray: [
              { name: "P250 | Sand Dune", basePrice: 2, image: "https://i.imgur.com/L1n7yYm.png" },
              { name: "Nova | Polar Mesh", basePrice: 3, image: "https://i.imgur.com/L1n7yYm.png" }
          ],
          blue: [
              { name: "SG 553 | Ultraviolet", basePrice: 50, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/SG%20553%20Ultraviolet.png?raw=true" },
			  { name: "AUG | Wings", basePrice: 17, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/AUG%20Wings.png?raw=true" },
			  { name: "MP7 | Skulls", basePrice: 17, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/MP7%20Skulls.png?raw=true" }
          ],
          purple: [
              { name: "Glock-18 | Dragon Tattoo", basePrice: 161, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/Glock-18%20Dragon%20Tattoo.png?raw=true" },
			  { name: "M4A1-S | Dark Water", basePrice: 122, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/M4A1-S%20Dark%20Water.png?raw=true" },
			  { name: "USP-S | Dark Water", basePrice: 101, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/M4A1-S%20Dark%20Water.png?raw=true" }
          ],
		  pink: [
              { name: "AK-47 | Case Hardened", basePrice: 980, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/AK-47%20Case%20Hardened.png?raw=true" },
			  { name: "Desert Eagle | Hypnotic", basePrice: 181, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/Desert%20Eagle%20Hypnotic.png?raw=true" }
          ],
          red: [
              { name: "AWP | Lightning Strike", basePrice: 1100, image: "https://github.com/kgmr8cr7p2-del/telegram-clicker/blob/main/CSGO%20Weapon%20Case/AWP%20Lightning%20Strike.png?raw=true" }
          ],
      }
    },
    {
      id: "case_rare", 
      name: "Редкий Кейс", 
      keyPrice: 300, 
      image: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXU5A1PIYQh5hlcX0nvUOGsx8DdQBJjIAVHubSaLwJh1P_NP28b6YywxdCIx6_2MOLUw24H7ZYp2-3I94mjjgXmqkU6ZmHzLdCRJgU9NVvQ-1G-w7u508O5vM_KyHpm7nQ8pSGK01d088Q",
      
      items: {
          purple: [
              { name: "M4A1-S | Decimator", basePrice: 150, image: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvN0_175QlQ2ZAoBvrWyLgJh0P33d0hu7Ti5m420k_mnIbrVk39UscZz2rCX9Nmm3Qy2-hJtMD30cI-WIFM5Z13Vr1LrlOy918W8757BzCc273V05XfD30vgPCCZ4bE/360fx360f" }
          ],
          pink: [
              { name: "AK-47 | Redline", basePrice: 400, image: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvN0_175QlQ2ZAoBvrWyLgJh0P33d0hu7Ti5m420k_mnIbrVk39UscZz2rCX9Nmm3Qy2-hJtMD30cI-WIFM5Z13Vr1LrlOy918W8757BzCc273V05XfD30vgPCCZ4bE/360fx360f" }
          ],
          red: [
              { name: "AWP | Asiimov", basePrice: 1500, image: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvN0_175QlQ2ZAoBvrWyLgJh0P33d0hu7Ti5m420k_mnIbrVk39UscZz2rCX9Nmm3Qy2-hJtMD30cI-WIFM5Z13Vr1LrlOy918W8757BzCc273V05XfD30vgPCCZ4bE/360fx360f" }
          ],
          gold: [
              { name: "★ Karambit | Fade", basePrice: 10000, image: "https://steamcommunity-a.akamaihd.net/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvN0_175QlQ2ZAoBvrWyLgJh0P33d0hu7Ti5m420k_mnIbrVk39UscZz2rCX9Nmm3Qy2-hJtMD30cI-WIFM5Z13Vr1LrlOy918W8757BzCc273V05XfD30vgPCCZ4bE/360fx360f" }
          ]
      }
    }
  ];

  let tg = window.Telegram.WebApp; tg.expand();
  let userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 10001; 

  // GLOBAL STATE
  let state = {
    balance: 0, clickPower: 1, autoClick: 0, inventory: [],
    activeCase: null,
    clicksDone: 0
  };
  let pendingItem = null;

  // --- КРАФТИНГ STATE ---
  let craftSelection = []; // Список ID выбранных предметов для крафта
  let targetRarityForCraft = null; // Редкость, которую потребляем

  // --- INITIALIZATION ---
  async function initGame() {
    let data = await apiCall('login');
    if (data && data.success) {
      // Logic to handle both old and new data structures
      if (Array.isArray(data.inventory)) {
        state.inventory = data.inventory;
      } else if (data.inventory && Array.isArray(data.inventory.items)) {
        state.inventory = data.inventory.items;
        state.activeCase = data.inventory.activeCase || null;
        state.clicksDone = data.inventory.clicksDone || 0;
      }
      
      state.balance = data.balance || 0;
      state.clickPower = data.clickPower || 1;
      state.autoClick = data.autoClick || 0;

      if (data.offlineBonus > 0) notify(`Офлайн доход: +${data.offlineBonus}$`);
      updateUI();
      setInterval(() => { if (state.autoClick > 0) { state.balance += state.autoClick; updateUI(); }}, 1000);
      setInterval(saveGame, 5000);
    }
  }

  // --- CLICK & DROP LOGIC ---
  function handleClick() {
    state.balance += state.clickPower;
    if (!state.activeCase) {
      state.clicksDone++;
      if (state.clicksDone >= DROP_THRESHOLD) {
        dropRandomCase();
        state.clicksDone = 0;
      }
    }
    updateUI();
  }

  function dropRandomCase() {
    let isRare = Math.random() > 0.8;
    let dropped = isRare ? CASES.find(c => c.id === 'case_rare') : CASES.find(c => c.id === 'case_common');
    
    state.activeCase = dropped.id;
    notify(`ВЫПАЛ ${dropped.name.toUpperCase()}!`);
    saveGame();
  }

  function buyKeyAndOpen() {
    if (!state.activeCase) return;
    let caseObj = CASES.find(c => c.id === state.activeCase);
    if (state.balance >= caseObj.keyPrice) {
      state.balance -= caseObj.keyPrice;
      spinRoulette(caseObj);
      
      state.activeCase = null;
      updateUI();
    } else {
      notify("Не хватает денег на ключ!");
    }
  }

  // --- ROULETTE (Рулетка) ---
  function spinRoulette(caseObj) {
    const overlay = document.getElementById('rouletteScreen');
    const strip = document.getElementById('strip');
    overlay.style.display = 'flex';
    strip.innerHTML = '';
    strip.style.transition = 'none';
    strip.style.transform = 'translateX(0px)';

    let items = [];
    const winIndex = 35;
    
    for(let i=0; i<50; i++) {
      let tpl = getRandomItemFromCase(caseObj);
      let item = generateItemObj(tpl);
      items.push(item);
      
      let div = document.createElement('div');
      div.className = 'roulette-item';
      let stripe = document.createElement('div');
      stripe.className = 'rarity-stripe';
      stripe.style.background = RARITY_COLORS[item.rarity];
      let img = document.createElement('img');
      img.src = item.image;
      div.append(img, stripe);
      strip.appendChild(div);
    }

    pendingItem = items[winIndex];
    setTimeout(() => {
      let offset = (winIndex * 131) - (window.innerWidth / 2) + 65 + (Math.random() * 60 - 30);
      strip.style.transition = "transform 5s cubic-bezier(0.15, 0, 0.10, 1)";
      strip.style.transform = `translateX(-${offset}px)`;
    }, 50);
    setTimeout(() => {
      overlay.style.display = 'none';
      showDropModal();
      saveGame();
    }, 5500);
  }

  // --- HELPERS (Помощники) ---
  function getRarityByChance() {
    let r = Math.random() * TOTAL_WEIGHT;
    let currentSum = 0;
    
    for (const rarity in RARITY_CHANCES) {
        currentSum += RARITY_CHANCES[rarity].weight;
        if (r <= currentSum) {
            return rarity;
        }
    }
    return 'gray';
  }

  function getRandomItemFromCase(caseObj) {
      const allRarities = Object.keys(RARITY_CHANCES);
      let selectedRarity = getRarityByChance();
      let rarityIndex = allRarities.indexOf(selectedRarity);
      while(rarityIndex >= 0 && (!caseObj.items[selectedRarity] || caseObj.items[selectedRarity].length === 0)) {
          rarityIndex++;
          selectedRarity = allRarities[rarityIndex];
      }

      if (!caseObj.items[selectedRarity] || caseObj.items[selectedRarity].length === 0) {
          const availableRarities = Object.keys(caseObj.items).filter(r => caseObj.items[r].length > 0);
          if (availableRarities.length > 0) {
              selectedRarity = availableRarities[Math.floor(Math.random() * availableRarities.length)];
          } else {
              return { name: "Ошибка!", rarity: "gray", basePrice: 0, image: "" };
          }
      }
      
      const availableItems = caseObj.items[selectedRarity];
      const tpl = availableItems[Math.floor(Math.random() * availableItems.length)];
      
      return { ...tpl, rarity: selectedRarity };
  }
  
  // Функция генерации предмета (добавлен уникальный ID)
  function generateItemObj(tpl) {
    let float = Math.random(); 
    let mult = 1 + (0.5 - float);
    return {
      id: Math.random().toString(36).substring(2, 9) + Date.now(), // Уникальный ID
      name: tpl.name, rarity: tpl.rarity, image: tpl.image,
      float: float.toFixed(3),
      wear: getWearName(float),
      price: Math.floor(tpl.basePrice * mult)
    };
  }

  function getWearName(f) {
    if (f < 0.07) return "Прямо с завода";
    if (f < 0.15) return "Немного поношенное";
    if (f < 0.38) return "После полевых";
    if (f < 0.45) return "Поношенное";
    return "Закаленное в боях";
  }

  // --- UI UPDATE ---
  function updateUI() {
    document.getElementById('balanceDisp').innerText = Math.floor(state.balance) + "$";
    document.getElementById('clickDisp').innerText = "+" + state.clickPower;
    document.getElementById('autoDisp').innerText = state.autoClick + "/s";
    document.getElementById('costClick').innerText = (50 * state.clickPower) + "$";
    document.getElementById('costAuto').innerText = (100 * (state.autoClick + 1)) + "$";
    document.getElementById('invCount').innerText = state.inventory.length;

    let progress = Math.min(state.clicksDone, DROP_THRESHOLD);
    let pct = (progress / DROP_THRESHOLD) * 100;
    document.getElementById('progressFill').style.width = pct + "%";
    document.getElementById('clicksToDrop').innerText = Math.max(0, DROP_THRESHOLD - progress);
    const dz = document.getElementById('dropZone');
    if (state.activeCase) {
      let c = CASES.find(x => x.id === state.activeCase);
      dz.className = "drop-zone active";
      dz.innerHTML = `
        <div class="case-display">
          <div class="case-title">${c.name}</div>
          <img src="${c.image}" class="case-img">
          <div class="key-price">Цена ключа: ${c.keyPrice}$</div>
          <button class="btn btn-key" onclick="buyKeyAndOpen()">КУПИТЬ КЛЮЧ</button>
        </div>
      `;
    } else {
      dz.className = "drop-zone";
      dz.innerHTML = `<div style="color: #666; font-size: 14px;">Пусто... Кликай (${state.clicksDone}/${DROP_THRESHOLD})</div>`;
    }
  }

  // --- MODALS & API ---
  function showDropModal() {
    let m = document.getElementById('dropModal');
    document.getElementById('dName').innerText = pendingItem.name;
    document.getElementById('dName').style.color = RARITY_COLORS[pendingItem.rarity];
    document.getElementById('dImg').src = pendingItem.image;
    document.getElementById('dWear').innerText = `${pendingItem.wear} (${pendingItem.float})`;
    document.getElementById('dPrice').innerText = pendingItem.price + "$";
    m.style.display = 'flex';
  }
  
  function sellDrop() { 
      state.balance += pendingItem.price;
      document.getElementById('dropModal').style.display = 'none'; 
      notify(`+${pendingItem.price}$`); 
      updateUI(); 
      saveGame(); 
  }
  
  function keepDrop() { 
      state.inventory.push(pendingItem);
      document.getElementById('dropModal').style.display = 'none'; 
      notify("В инвентаре"); 
      updateUI(); 
      saveGame(); 
      // Проверка на открытые экраны (Инвентарь/Крафт)
      if (document.getElementById('inventoryScreen').style.display === 'flex') {
          toggleInventory(true);
      }
      if (document.getElementById('craftingRaritySelectScreen').style.display === 'flex') {
          toggleCrafting(true);
      }
  }
  
  function toggleInventory(show) {
    const g = document.getElementById('inventoryGrid');
    document.getElementById('inventoryScreen').style.display = show ? 'flex' : 'none';
    if(show) {
      g.innerHTML = '';
      state.inventory.forEach((it, idx) => {
        let div = document.createElement('div'); 
        div.className='inv-card'; 
        div.style.borderTopColor=RARITY_COLORS[it.rarity];
        div.innerHTML = `<img src="${it.image}"><div style="font-size:9px; text-align:center; margin-bottom:5px; color:${RARITY_COLORS[it.rarity]}">${it.name}</div><div style="font-size:8px; color:#aaa; margin-bottom: 5px;">${it.wear} (${it.float})</div><button class="inv-sell-btn" onclick="sellInv('${it.id}')">${it.price}$</button>`;
        g.appendChild(div);
      });
    }
  }
  
  window.sellInv = function(itemId) { 
      const index = state.inventory.findIndex(it => it.id === itemId);
      if (index !== -1) {
          state.balance += state.inventory[index].price; 
          state.inventory.splice(index, 1); 
          toggleInventory(true); // Перерисовка
          updateUI(); 
          saveGame(); 
      }
  }
  
  // --- ЛОГИКА МАГАЗИНА КЕЙСОВ ---
  function toggleCaseStore(show) {
    const store = document.getElementById('caseStoreContent');
    document.getElementById('caseStoreScreen').style.display = show ? 'flex' : 'none';

    if (show) {
        store.innerHTML = '';
        
        CASES.forEach(caseObj => {
            let cardHTML = `
                <div class="case-list-item">
                    <div class="case-list-info">
                        <img src="${caseObj.image}" alt="${caseObj.name}">
                        <div>
                            <h3>${caseObj.name}</h3>
                            <p>Цена ключа: ${caseObj.keyPrice}$</p>
                        </div>
                    </div>
                    <button class="case-details-btn" onclick="showCaseDetails('${caseObj.id}')">
                        Подробнее
                    </button>
                </div>
            `;
            store.innerHTML += cardHTML;
        });
    }
  }
  window.showCaseDetails = function(caseId) {
    const caseObj = CASES.find(c => c.id === caseId);
    if (!caseObj) return;

    const detailsModal = document.getElementById('caseDetailsModal');
    const content = document.getElementById('caseDetailsContent');
    document.getElementById('caseDetailsTitle').innerText = `Содержимое ${caseObj.name}`;
    content.innerHTML = '';
    let allItemsHtml = '';

    Object.keys(RARITY_CHANCES).reverse().forEach(rarityKey => {
        const itemsInRarity = caseObj.items[rarityKey];
        
        if (itemsInRarity && itemsInRarity.length > 0) {
            const rarityInfo = RARITY_CHANCES[rarityKey];
            
            let gridHtml = '<div class="details-item-grid">';
          
            itemsInRarity.forEach(item => {
                gridHtml += `
                    <div class="details-item-card" style="border-top-color: ${rarityInfo.color};">
                        <img src="${item.image}" alt="${item.name}">
                        <span style="color: ${rarityInfo.color};">${item.name}</span>
                        <div class="details-item-rarity">${rarityInfo.label.split(' ')[0]}</div>
                    </div>
                `;
            });
          
            gridHtml += '</div>';

            allItemsHtml += `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: ${rarityInfo.color}; border-left: 4px solid ${rarityInfo.color}; padding-left: 10px;">${rarityInfo.label}</h4>
                    ${gridHtml}
                </div>
            `;
        }
    });

    if (allItemsHtml === '') {
        content.innerHTML = '<p style="text-align:center;">Кейс пуст или данные не найдены.</p>';
    } else {
        content.innerHTML = allItemsHtml;
    }

    detailsModal.style.display = 'flex';
  }
  window.hideCaseDetails = function() {
    document.getElementById('caseDetailsModal').style.display = 'none';
  }
  
  // --- НОВАЯ ЛОГИКА КРАФТИНГА С ВЫБОРОМ ---
  const CRAFT_COUNT_REQUIRED = 10;

  // 1. Отображает доступные крафты по редкости
  function toggleCrafting(show) {
      const screen = document.getElementById('craftingRaritySelectScreen');
      const content = document.getElementById('craftingRarityContent');
      screen.style.display = show ? 'flex' : 'none';

      if (show) {
          content.innerHTML = '';
          
          const countsByRarity = state.inventory.reduce((acc, item) => {
              acc[item.rarity] = (acc[item.rarity] || 0) + 1;
              return acc;
          }, {});

          let craftOptionsHtml = '';
          let canCraftExists = false;

          // Перебор редкостей от самой низкой до "red" (предпоследняя, 'gold' нельзя скрафтить)
          for (let i = 0; i < RARITY_ORDER.length - 1; i++) {
              const currentRarity = RARITY_ORDER[i];
              const nextRarity = RARITY_ORDER[i + 1];
              
              const count = countsByRarity[currentRarity] || 0;
              const rarityInfo = RARITY_CHANCES[currentRarity];
              const nextRarityInfo = RARITY_CHANCES[nextRarity];

              if (count >= CRAFT_COUNT_REQUIRED) {
                  canCraftExists = true;

                  craftOptionsHtml += `
                      <div style="margin-bottom: 10px; background: var(--card-bg); padding: 10px; border-radius: 8px; border-left: 5px solid ${rarityInfo.color}; display: flex; justify-content: space-between; align-items: center;">
                          <div>
                              <h4 style="margin: 0; color: ${rarityInfo.color};">${rarityInfo.label.split(' ')[0]} (${count} шт.)</h4>
                              <p style="margin: 0; font-size: 11px; color: #aaa;">Для крафта 1 шт. ${nextRarityInfo.label.split(' ')[0]}</p>
                          </div>
                          <button class="btn btn-buy" style="padding: 8px 12px; margin-left: 10px;" 
                                  onclick="showCraftingItemSelect('${currentRarity}')">
                              Выбрать
                          </button>
                      </div>
                  `;
              }
          }
          
          if (!canCraftExists) {
              content.innerHTML = '<p style="text-align:center; color:#aaa; margin-top: 50px;">У вас нет 10 одинаковых предметов для крафта.</p>';
          } else {
              content.innerHTML = craftOptionsHtml;
          }
      }
  }
  
  // 2. Отображает экран выбора предметов
  window.showCraftingItemSelect = function(rarity) {
      targetRarityForCraft = rarity;
      craftSelection = []; // Сброс выбора
      const items = state.inventory.filter(it => it.rarity === rarity);
      const grid = document.getElementById('craftingSelectedItemGrid');
      
      document.getElementById('craftItemSelectTitle').innerText = `Выберите 10x ${RARITY_CHANCES[rarity].label.split(' ')[0]}`;
      updateCraftSelectionDisplay();

      document.getElementById('craftingRaritySelectScreen').style.display = 'none';
      document.getElementById('craftingItemSelectScreen').style.display = 'flex';
      
      grid.innerHTML = '';
      items.forEach((it) => {
          let card = document.createElement('div');
          card.className = 'inv-card craftable-item';
          card.dataset.itemId = it.id;
          card.style.borderTopColor = RARITY_COLORS[it.rarity];
          card.style.position = 'relative';
          // Используем замыкание для передачи card в функцию
          card.onclick = (function(c) {
            return function() { toggleItemSelection(it.id, c); };
          })(card); 
          
          card.innerHTML = `
              <img src="${it.image}">
              <div style="font-size:9px; text-align:center; margin-bottom:5px; color:${RARITY_COLORS[it.rarity]}">${it.name}</div>
              <div style="font-size:8px; color:#aaa; margin-bottom: 5px;">${it.wear} (${it.float})</div>
              <div class="selection-overlay">
                  ✓
              </div>
          `;
          grid.appendChild(card);
      });
  }

  // Скрытие экрана выбора
  window.hideCraftingItemSelect = function() {
      document.getElementById('craftingItemSelectScreen').style.display = 'none';
      toggleCrafting(true); // Возврат к экрану выбора редкости
  }

  // 3. Логика выбора/отмены выбора предмета
  function toggleItemSelection(itemId, card) {
      const index = craftSelection.indexOf(itemId);
      const overlay = card.querySelector('.selection-overlay');
      
      if (index === -1) {
          // Выбор
          if (craftSelection.length < CRAFT_COUNT_REQUIRED) {
              craftSelection.push(itemId);
              card.classList.add('selected-for-craft');
              overlay.style.display = 'flex';
          } else {
              notify(`Максимум ${CRAFT_COUNT_REQUIRED} предметов!`);
          }
      } else {
          // Отмена выбора
          craftSelection.splice(index, 1);
          card.classList.remove('selected-for-craft');
          overlay.style.display = 'none';
      }
      
      updateCraftSelectionDisplay();
  }
  
  // Обновление счетчика выбора
  function updateCraftSelectionDisplay() {
      document.getElementById('craftSelectionCount').innerText = craftSelection.length;
      const finalizeBtn = document.getElementById('finalizeCraftBtn');
      if (craftSelection.length === CRAFT_COUNT_REQUIRED) {
          finalizeBtn.disabled = false;
          finalizeBtn.innerText = `Скрафтить (1)`;
      } else {
          finalizeBtn.disabled = true;
          finalizeBtn.innerText = `Скрафтить (${CRAFT_COUNT_REQUIRED - craftSelection.length} нужно)`;
      }
  }

  // 4. Финализация крафта
  window.finalizeCraft = function() {
      if (craftSelection.length !== CRAFT_COUNT_REQUIRED || !targetRarityForCraft) {
          notify(`Для крафта нужно ровно ${CRAFT_COUNT_REQUIRED} предметов!`);
          return;
      }
      
      const currentRarity = targetRarityForCraft;
      const nextRarityIndex = RARITY_ORDER.indexOf(currentRarity) + 1;
      const nextRarity = RARITY_ORDER[nextRarityIndex];

      if (!nextRarity || nextRarity === 'gold') {
          notify("Нельзя скрафтить выше Красного!");
          return;
      }
      
      // 1. Удаление выбранных предметов (фильтруем инвентарь, оставляя те, ID которых НЕТ в списке крафта)
      state.inventory = state.inventory.filter(it => !craftSelection.includes(it.id));
      
      // 2. Добавление нового, более редкого предмета
      const availableCases = CASES.filter(c => Object.keys(c.items).includes(nextRarity));
      if (availableCases.length === 0) {
          notify("Ошибка! Нет кейсов с предметами нужной редкости.");
          return;
      }
      
      const randomCase = availableCases[Math.floor(Math.random() * availableCases.length)];
      const availableItems = randomCase.items[nextRarity];
      const tpl = availableItems[Math.floor(Math.random() * availableItems.length)];
      
      const newItem = generateItemObj({ ...tpl, rarity: nextRarity });
      state.inventory.push(newItem);

      // 3. Очистка и обновление
      craftSelection = [];
      targetRarityForCraft = null;
      
      updateUI();
      saveGame();
      document.getElementById('craftingItemSelectScreen').style.display = 'none';
      toggleCrafting(true); // Перерисовка меню крафта
      
      notify(`Скрафчен 1x ${newItem.name} (${newItem.wear})!`);
  }

  // --- КОНЕЦ НОВОЙ ЛОГИКИ КРАФТИНГА ---

  function buyUpgrade(t) { 
      let c = t==='click'?50*state.clickPower:100*(state.autoClick+1); 
      if(state.balance>=c){
          state.balance-=c; 
          t==='click'?state.clickPower++:state.autoClick++; 
          updateUI();
          saveGame();
      } 
  }
  
  async function apiCall(act, pl={}) {
    if(act === 'save') { pl = { items: state.inventory, activeCase: state.activeCase, clicksDone: state.clicksDone, ...pl };
    }
    try { let r = await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:act, telegramId:userId, payload:pl})}); return await r.json();
    } catch(e){return null;}
  }
  function saveGame() { 
      apiCall('save', { 
          balance: state.balance, 
          clickPower: state.clickPower, 
          autoClick: state.autoClick 
      });
  }
  function notify(m) { let n=document.getElementById('notification'); n.innerText=m; n.style.display='block'; setTimeout(()=>n.style.display='none', 2000); }
  
  window.onload = initGame;
</script>
</body>
</html>