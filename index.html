<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>🎮 CS2 Кликер + Кейсы</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      cursor: default;
      touch-action: manipulation;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 15px;
    }

    .container {
      text-align: center;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #4fc3f7;
    }

    .score {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: gold;
    }

    .case-count {
      font-size: 16px;
      margin: 8px 0;
      color: #aaffaa;
    }

    .click-btn,
    .open-case-btn,
    .inv-btn {
      width: 120px;
      height: 120px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin: 12px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease;
    }

    .click-btn {
      background: linear-gradient(135deg, #ff9a00, #ff5200);
      box-shadow: 0 6px 18px rgba(255, 82, 0, 0.4);
    }

    .open-case-btn {
      background: linear-gradient(135deg, #00b09b, #96c93d);
      box-shadow: 0 6px 18px rgba(0, 176, 155, 0.4);
    }

    .open-case-btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }

    .inv-btn {
      background: linear-gradient(135deg, #6a00ff, #b027ff);
      box-shadow: 0 6px 18px rgba(106, 0, 255, 0.4);
      width: auto;
      padding: 8px 20px;
      border-radius: 12px;
      font-size: 14px;
    }

    .click-btn:active,
    .open-case-btn:active,
    .inv-btn:active {
      transform: scale(0.94);
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #aaffaa;
    }

    /* РУЛЕТКА */
    .roulette-wrapper {
      position: relative;
      width: 100%;
      margin: 15px 0;
    }

    .roulette-arrow {
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.9);
      z-index: 20;
      pointer-events: none;
    }

    .roulette-container {
      width: 100%;
      height: 120px;
      overflow: hidden;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.25);
    }

    .roulette-track {
      display: flex;
      align-items: center;
      height: 120px;
      transition: transform 0.1s linear;
    }

    .skin-item {
      min-width: 90px;
      height: 100px;
      margin: 0 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 4px;
      font-size: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      text-align: center;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .skin-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 4px;
      border-radius: 4px;
    }

    .skin-quality {
      font-size: 8px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .highlight {
      transform: scale(1.15);
      box-shadow: 0 0 16px gold;
      z-index: 10;
      position: relative;
    }

    /* РЕЗУЛЬТАТ */
    .result-box {
      margin-top: 15px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      display: none;
    }

    .result-name { font-weight: bold; font-size: 16px; }
    .result-quality { font-size: 13px; margin-top: 3px; }
    .result-rarity { font-size: 13px; margin-top: 2px; font-style: italic; }
    .result-mod { font-size: 12px; margin-top: 3px; color: gold; }

    /* ИНВЕНТАРЬ */
    .inventory-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      padding: 20px;
      overflow-y: auto;
    }

    .inventory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .inventory-title {
      color: white;
      font-size: 20px;
    }

    .close-inv {
      background: #ff4d4d;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
    }

    .inv-item {
      background: rgba(30, 30, 40, 0.7);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 14px;
      text-align: left;
      border-left: 4px solid #4b69ff;
      display: flex;
      align-items: center;
    }

    .inv-item.stattrak { border-left-color: gold; }
    .inv-item.souvenir { border-left-color: #00ffcc; }

    .inv-item img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 4px;
    }

    .inv-item-info {
      flex: 1;
    }

    .inv-item-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .inv-item-meta {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 4px;
    }

    .sell-btn {
      background: linear-gradient(135deg, #ff3366, #ff6600);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 6px;
      font-weight: bold;
      width: auto;
    }

    .sell-btn:active {
      transform: scale(0.96);
    }

    /* МОДАЛЬНОЕ ОКНО ПРОДАЖИ */
    .sell-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 200;
      padding: 20px;
      justify-content: center;
      align-items: center;
    }

    .sell-content {
      background: rgba(20,20,30,0.95);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }

    .sell-price {
      font-size: 24px;
      font-weight: bold;
      color: gold;
      margin: 10px 0;
    }

    .sell-confirm-btn, .sell-cancel-btn {
      margin: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .sell-confirm-btn {
      background: #4caf50;
      color: white;
    }

    .sell-cancel-btn {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎮 CS2 Кликер + Кейсы</h1>
    <div class="score">Очки: <span id="score">0</span></div>
    <div class="case-count">Кейсов: <span id="caseCount">0</span></div>
    <button class="click-btn" id="clickBtn">КЛИК!</button>
    <button class="open-case-btn" id="openCaseBtn" disabled>Открыть кейс</button>
    <button class="inv-btn" id="invBtn">Инвентарь</button>
    <div class="status" id="status">Загрузка...</div>

    <div class="roulette-wrapper">
      <div class="roulette-arrow">▼</div>
      <div class="roulette-container">
        <div class="roulette-track" id="rouletteTrack"></div>
      </div>
    </div>

    <div class="result-box" id="resultBox">
      <div class="result-name" id="resultName">—</div>
      <div class="result-quality" id="resultQuality">—</div>
      <div class="result-rarity" id="resultRarity">—</div>
      <div class="result-mod" id="resultMod"></div>
    </div>
  </div>

  <!-- ИНВЕНТАРЬ -->
  <div class="inventory-modal" id="invModal">
    <div class="inventory-header">
      <div class="inventory-title">🎒 Инвентарь</div>
      <button class="close-inv" id="closeInv">✕</button>
    </div>
    <div id="invList">Загрузка...</div>
  </div>

  <!-- ПРОДАЖА -->
  <div class="sell-modal" id="sellModal">
    <div class="sell-content">
      <h3>💰 Продать предмет?</h3>
      <div id="sellItemName" style="font-weight:bold; margin:8px 0;"></div>
      <div>Вы получите:</div>
      <div class="sell-price" id="sellPrice">0 очков</div>
      <button class="sell-confirm-btn" id="sellConfirm">Продать</button>
      <button class="sell-cancel-btn" id="sellCancel">Отмена</button>
    </div>
  </div>

  <script>
    // ===== НАСТРОЙКИ =====
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwa5Xl9TyUGpH7rITh2J_s3ER656u3rqYeIW2v6fMMIZURavVXCg_H-fVM_Xgm0yD56/exec";

    // ===== CS2 ДАННЫЕ =====
    const QUALITIES = [
      { name: "FN", fullName: "Прямо с завода", color: "#b0c3d9" },
      { name: "MW", fullName: "Немного поношенное", color: "#5e92f3" },
      { name: "FT", fullName: "После полевых испытаний", color: "#4b69ff" },
      { name: "WW", fullName: "Поношенное", color: "#8847ff" },
      { name: "BS", fullName: "Закалённое в боях", color: "#d32ce6" }
    ];

    const RARITIES = [
      { name: "Ширпотреб", color: "#b0c3d9" },
      { name: "Промышленное", color: "#5e92f3" },
      { name: "Армейское", color: "#4b69ff" },
      { name: "Запрещенное", color: "#8847ff" },
      { name: "Засекреченное", color: "#d32ce6" },
      { name: "Тайное", color: "#eb4b4b" }
    ];

    const CASES = [
      {
        name: "Chroma Case",
        weapons: [
          { name: "MP9 | Deadly Poison", rarity: 2, img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7cqWdQ68jj0L-DptqijQXk-hVvZ23wcIKVJlQ7N1yD_VK_xO7p1JS4uJ3KzC5juHc/64fx64f" },
          { name: "P250 | Muertos", rarity: 2, img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7c2G9SupUijOjAotygjQa3-hBqZT77d4DDJlRvNQ7T-FDrwOnv15-9u5rMnyRm7nN1-z-DyGo/64fx64f" }
        ]
      },
      {
        name: "Gamma Case",
        weapons: [
          { name: "Nova | Hyper Beast", rarity: 2, img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7c2G9SupUijOjAotygjQa3-hBqZT77d4DDJlRvNQ7T-FDrwOnv15-9u5rMnyRm7nN1-z-DyGo/64fx64f" },
          { name: "USP-S | Cyrex", rarity: 3, img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7cqWdQ68jj0L-DptqijQXk-hVvZ23wcIKVJlQ7N1yD_VK_xO7p1JS4uJ3KzC5juHc/64fx64f" }
        ]
      },
      // === ТВОЙ КАСТОМНЫЙ КЕЙС ===
      {
        name: "CyberPunk Case",
        weapons: [
          { 
            name: "AWP | Dragon Lore", 
            rarity: 5, 
            img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7c2G9SupUijOjAotygjQa3-hBqZT77d4DDJlRvNQ7T-FDrwOnv15-9u5rMnyRm7nN1-z-DyGo/128fx128f" 
          },
          { 
            name: "AK-47 | Vulcan", 
            rarity: 4, 
            img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7cqWdQ68jj0L-DptqijQXk-hVvZ23wcIKVJlQ7N1yD_VK_xO7p1JS4uJ3KzC5juHc/128fx128f" 
          },
          { 
            name: "M4A4 | Howl", 
            rarity: 5, 
            img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgposbaqKAxf0vL3dzRY7dG0mYi0k_jkI7LWl25V18l4jeHVu9v0jBq1-hJpYW37JtfGc1I5M17Z-FC7xOztgZK17ZiYzHY3viE/128fx128f" 
          },
          { 
            name: "Desert Eagle | Blaze", 
            rarity: 4, 
            img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfAR17OL3YQJD_9W7m5a0mvLwOq7cqWdQ68jj0L-DptqijQXk-hVvZ23wcIKVJlQ7N1yD_VK_xO7p1JS4uJ3KzC5juHc/128fx128f" 
          },
          { 
            name: "Glock-18 | Fade", 
            rarity: 3, 
            img: "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot621FAR17PLfYQJD_9W7m5a0mvLwOq7c2G9SupUijOjAotygjQa3-hBqZT77d4DDJlRvNQ7T-FDrwOnv15-9u5rMnyRm7nN1-z-DyGo/128fx128f" 
          }
        ]
      }
    ];

    // ===== ГЛОБАЛЬНЫЙ СОСТОЯНИЕ =====
    let player = {
      id: null,
      name: "Гость",
      score: 0,
      caseProgress: 0,
      cases: [],
      isLoaded: false,
      inventory: []
    };
    let isSpinning = false;
    let sellPendingIndex = -1;

    // ===== DOM =====
    const scoreEl = document.getElementById('score');
    const caseCountEl = document.getElementById('caseCount');
    const statusEl = document.getElementById('status');
    const clickBtn = document.getElementById('clickBtn');
    const openCaseBtn = document.getElementById('openCaseBtn');
    const invBtn = document.getElementById('invBtn');
    const invModal = document.getElementById('invModal');
    const invList = document.getElementById('invList');
    const closeInv = document.getElementById('closeInv');
    const rouletteTrack = document.getElementById('rouletteTrack');
    const resultBox = document.getElementById('resultBox');
    const resultName = document.getElementById('resultName');
    const resultQuality = document.getElementById('resultQuality');
    const resultRarity = document.getElementById('resultRarity');
    const resultMod = document.getElementById('resultMod');
    const sellModal = document.getElementById('sellModal');
    const sellConfirm = document.getElementById('sellConfirm');
    const sellCancel = document.getElementById('sellCancel');

    // ===== УТИЛИТЫ =====
    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? '#ff9999' : '#aaffaa';
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function calculateItemPrice(weaponName, qualityFullName, rarityName, statTrak = false, souvenir = false) {
      const rarityValue = RARITIES.findIndex(r => r.name === rarityName);
      const qualityValue = QUALITIES.findIndex(q => q.fullName === qualityFullName);
      let base = (rarityValue + 1) * 10 + (qualityValue + 1) * 2;
      let bonus = 0;
      if (statTrak) bonus += 0.3;
      if (souvenir) bonus += 0.5;
      const withBonus = base * (1 + bonus);
      const randomFactor = 0.8 + Math.random() * 0.4;
      return Math.floor(withBonus * randomFactor);
    }

    function generateSkinItem(weapon, quality, rarity, statTrak = false, souvenir = false) {
      const el = document.createElement('div');
      el.className = 'skin-item';
      el.style.backgroundColor = rarity.color + '30';
      
      if (weapon.img) {
        el.innerHTML = `
          <img src="${weapon.img}" alt="${weapon.name}">
          <div>${weapon.name}</div>
          <div class="skin-quality">${quality.name}</div>
        `;
      } else {
        el.innerHTML = `<div>${weapon.name}</div><div class="skin-quality">${quality.name}</div>`;
      }
      
      if (statTrak) el.style.borderTop = '2px solid gold';
      if (souvenir) el.style.borderBottom = '2px solid #00ffcc';
      return el;
    }

    function generateCaseSkins(caseType, count) {
      const skins = [];
      for (let i = 0; i < count; i++) {
        const weapon = caseType.weapons[getRandomInt(0, caseType.weapons.length - 1)];
        const rarity = RARITIES[weapon.rarity];
        const quality = QUALITIES[getRandomInt(0, QUALITIES.length - 1)];
        const statTrak = Math.random() < 0.08;
        const souvenir = !statTrak && Math.random() < 0.03;
        skins.push({ weapon, quality, rarity, statTrak, souvenir });
      }
      return skins;
    }

    function renderRoulette(skins) {
      rouletteTrack.innerHTML = '';
      skins.forEach(skin => {
        const el = generateSkinItem(skin.weapon, skin.quality, skin.rarity, skin.statTrak, skin.souvenir);
        rouletteTrack.appendChild(el);
      });
    }

    // ===== GAS =====
    async function loadPlayerFromGAS() {
      const url = `${GAS_URL}?action=getPlayer&id=${encodeURIComponent(player.id)}&name=${encodeURIComponent(player.name)}&_=${Date.now()}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.success) {
        player.score = data.found ? (parseInt(data.score) || 0) : 0;
        player.caseProgress = data.caseProgress || 0;
        player.cases = data.cases ? JSON.parse(data.cases) : [];
        player.inventory = data.inventory ? JSON.parse(data.inventory) : [];
        player.isLoaded = true;
        updateCaseUI();
        return true;
      }
      throw new Error("GAS error");
    }

    function savePlayerData() {
      if (!player.id || !player.isLoaded) return;
      
      const img1 = new Image();
      const params1 = new URLSearchParams({
        action: "updatePlayer",
        id: player.id,
        score: player.score,
        caseProgress: player.caseProgress,
        cases: JSON.stringify(player.cases)
      });
      img1.src = `${GAS_URL}?${params1}&_=${Date.now()}`;

      const img2 = new Image();
      const params2 = new URLSearchParams({
        action: "updateInventory",
        id: player.id,
        inventory: JSON.stringify(player.inventory)
      });
      img2.src = `${GAS_URL}?${params2}&_=${Date.now()}`;
    }

    // ===== КЕЙСЫ =====
    function giveRandomCase() {
      player.cases = [];
      const caseType = CASES[Math.floor(Math.random() * CASES.length)];
      player.cases.push(caseType.name);
      setStatus(`🎁 Получен ${caseType.name}!`);
      updateCaseUI();
      savePlayerData();
    }

    function updateCaseUI() {
      caseCountEl.textContent = player.cases.length;
      openCaseBtn.disabled = (player.cases.length === 0 || player.score < 10);
    }

    function openCase() {
      if (player.cases.length === 0 || player.score < 10) return;

      const caseName = player.cases.pop();
      const caseType = CASES.find(c => c.name === caseName);
      if (!caseType) return;

      player.score -= 10;
      scoreEl.textContent = player.score;
      updateCaseUI();
      savePlayerData();
      setStatus("Крутим...");

      resultBox.style.display = 'none';

      const preSpin = generateCaseSkins(caseType, 30);
      const weapon = caseType.weapons[getRandomInt(0, caseType.weapons.length - 1)];
      const rarity = RARITIES[weapon.rarity];
      const quality = QUALITIES[getRandomInt(0, QUALITIES.length - 1)];
      const statTrak = Math.random() < 0.08;
      const souvenir = !statTrak && Math.random() < 0.03;
      const winSkin = { weapon, quality, rarity, statTrak, souvenir };
      const postSpin = generateCaseSkins(caseType, 15);
      const fullList = [...preSpin, winSkin, ...postSpin];
      renderRoulette(fullList);

      setTimeout(() => {
        const itemWidth = 102; // 90 + 2*6 margin
        const winIndex = preSpin.length;
        const containerWidth = document.querySelector('.roulette-container').offsetWidth;
        const targetCenter = winIndex * itemWidth + itemWidth / 2;
        const scrollLeft = targetCenter - containerWidth / 2;

        rouletteTrack.style.transition = 'none';
        rouletteTrack.style.transform = 'translateX(0)';
        rouletteTrack.offsetHeight;
        rouletteTrack.style.transition = 'transform 3s cubic-bezier(0.16, 1, 0.3, 1)';
        rouletteTrack.style.transform = `translateX(${-scrollLeft}px)`;

        setTimeout(() => {
          isSpinning = false;
          const items = rouletteTrack.querySelectorAll('.skin-item');
          items.forEach(el => el.classList.remove('highlight'));
          if (items[winIndex]) items[winIndex].classList.add('highlight');

          resultName.textContent = weapon.name;
          resultQuality.textContent = quality.fullName;
          resultQuality.style.color = quality.color;
          resultRarity.textContent = rarity.name;
          resultRarity.style.color = rarity.color;

          const mods = [];
          if (statTrak) mods.push("StatTrak™");
          if (souvenir) mods.push("Сувенир");
          resultMod.textContent = mods.join(" | ");
          resultMod.style.display = mods.length ? 'block' : 'none';
          resultBox.style.display = 'block';

          const price = calculateItemPrice(
            weapon.name,
            quality.fullName,
            rarity.name,
            statTrak,
            souvenir
          );
          const newItem = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            weapon: weapon.name,
            quality: quality.name,
            qualityFullName: quality.fullName,
            rarity: rarity.name,
            statTrak: statTrak,
            souvenir: souvenir,
            price: price,
            img: weapon.img,
            timestamp: Date.now()
          };
          player.inventory.push(newItem);
          savePlayerData();
          setStatus("✅ Предмет сохранён!");
        }, 3100);
      }, 50);
    }

    // ===== ИНВЕНТАРЬ И ПРОДАЖА =====
    function renderInventory() {
      if (!player.isLoaded) {
        invList.innerHTML = "Загрузка...";
        return;
      }

      if (player.inventory.length === 0) {
        invList.innerHTML = '<div style="color:#aaa; font-style:italic; text-align:center; padding:20px;">Пусто</div>';
        return;
      }

      const sorted = [...player.inventory].sort((a, b) => b.timestamp - a.timestamp);
      let html = '';
      sorted.forEach((item, index) => {
        let mods = [];
        if (item.statTrak) mods.push("StatTrak™");
        if (item.souvenir) mods.push("Сувенир");
        const modText = mods.length ? ` (${mods.join(" | ")})` : '';

        html += `
          <div class="inv-item ${item.statTrak ? 'stattrak' : ''} ${item.souvenir ? 'souvenir' : ''}">
            ${item.img ? `<img src="${item.img}" alt="${item.weapon}">` : ''}
            <div class="inv-item-info">
              <div class="inv-item-name">${item.weapon}</div>
              <div class="inv-item-meta">${item.qualityFullName} • ${item.rarity}${modText}</div>
              <div style="font-size:13px; color:gold;">💰 Цена: ${item.price} очков</div>
              <button class="sell-btn" data-index="${index}">Продать</button>
            </div>
          </div>
        `;
      });
      invList.innerHTML = html;

      document.querySelectorAll('.sell-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          showSellModal(index);
        });
      });
    }

    function showSellModal(index) {
      const item = player.inventory[index];
      if (!item) return;

      sellPendingIndex = index;
      document.getElementById('sellItemName').textContent = item.weapon;
      document.getElementById('sellPrice').textContent = `${item.price} очков`;
      sellModal.style.display = 'flex';
    }

    // ===== ИНИЦИАЛИЗАЦИЯ =====
    (async () => {
      const tg = window.Telegram?.WebApp;
      if (tg?.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        player.id = String(user.id);
        player.name = user.username 
          ? '@' + user.username 
          : (user.first_name || "Игрок") + (user.last_name ? " " + user.last_name : "");
        try { tg.expand(); } catch (e) {}
        setStatus("Подключение...");
        try {
          await loadPlayerFromGAS();
          setStatus("✅ Готово");
        } catch (e) {
          console.error("GAS load failed", e);
          player.isLoaded = true;
          player.inventory = [];
          setStatus("⚠️ Офлайн-режим", true);
        }
      } else {
        player.id = "test_" + Math.floor(Math.random() * 1000000);
        player.name = "Тест";
        player.isLoaded = true;
        player.inventory = [];
        setStatus("🧪 Тестовый режим", true);
      }

      scoreEl.textContent = player.score;
      caseCountEl.textContent = player.cases.length;
      renderRoulette(generateCaseSkins(CASES[0], 25));

      clickBtn.addEventListener('click', () => {
        player.score += 1;
        scoreEl.textContent = player.score;

        if (player.cases.length === 0) {
          player.caseProgress += 1;
          if (player.caseProgress >= 20) {
            player.caseProgress = 0;
            giveRandomCase();
          }
        }

        if (player.score % 5 === 0) savePlayerData();
        updateCaseUI();
      });

      openCaseBtn.addEventListener('click', openCase);
      invBtn.addEventListener('click', () => {
        renderInventory();
        invModal.style.display = 'block';
      });
      closeInv.addEventListener('click', () => {
        invModal.style.display = 'none';
      });
      sellCancel.addEventListener('click', () => {
        sellModal.style.display = 'none';
        sellPendingIndex = -1;
      });
      sellConfirm.addEventListener('click', () => {
        if (sellPendingIndex === -1 || sellPendingIndex >= player.inventory.length) return;
        const item = player.inventory[sellPendingIndex];
        player.score += item.price;
        player.inventory.splice(sellPendingIndex, 1);
        scoreEl.textContent = player.score;
        savePlayerData();
        renderInventory();
        sellModal.style.display = 'none';
        sellPendingIndex = -1;
        setStatus(`✅ +${item.price} очков!`);
      });

      setInterval(savePlayerData, 30000);
    })();
  </script>
</body>
</html>