<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Clicker Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; background: #f7f9fc; }
    h1 { color: #222; }
    button { padding: 10px 15px; font-size: 16px; border-radius: 8px; border: none; background: #3390ec; color: white; cursor: pointer; margin: 8px; }
    #authMessage { color: #d63031; margin: 20px; padding: 20px; background: #ffeaa7; border-radius: 10px; }
    #game { display: none; }
    .status { margin: 8px; padding: 8px; border-radius: 5px; font-size: 13px; }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .status-info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
    .energy-bar {
      width: 80%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      margin: 10px auto;
      overflow: hidden;
    }
    .energy-fill {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h1>🎮 Энерго-Кликер</h1>
  
  <div id="authMessage">
    <h3>Запускайте игру через Telegram бота!</h3>
    <p>Эта игра работает только внутри Telegram.</p>
    <button onclick="simulateTelegram()">Тестовый режим</button>
  </div>
  
  <div id="game">
    <p id="user"></p>
    <p>Очки: <span id="score">0</span></p>
    
    <div class="energy-bar">
      <div class="energy-fill" id="energyFill" style="width: 100%;"></div>
    </div>
    <p>Энергия: <span id="energy">100</span> / 650</p>
    
    <button id="clickBtn">Клик! (–5 ⚡)</button>
    <br>
    <button onclick="buyEnergyRegen()">🔋 +1 энергии/сек (Цена: <span id="regenCost">10</span>)</button>
    <button onclick="buyAutoClicker()">🤖 +1 автоклик/сек (Цена: <span id="autoClickerCost">50</span>)</button>
    <br>
    <p>Автокликер: <span id="autoClickerLevel">0</span> уровней</p>
    <button onclick="forceSave()">💾 Сохранить</button>
  </div>

  <script>
    // === ВСТАВЬТЕ СЮДА ВАШ РАБОЧИЙ URL ИЗ GAS ===
    const apiUrl = "https://script.google.com/macros/s/AKfycbxWpGypJLFCjzYrpa0H3-NLh6qCZp3gFgrsZ4zmvErBu23k0Ux5BENda7Fdykc1dQbI/exec";

    const tg = window.Telegram.WebApp;

    let player = {
      id: null,
      name: 'Гость',
      score: 0,
      energy: 100,
      maxEnergy: 650,
      energyRegen: 1,
      energyUpgrades: 0,
      autoClickerLevel: 0,
      lastSavedScore: 0,
      isInitialized: false
    };

    function getEnergyRegenCost(upgrades) {
      const base = 10;
      if (upgrades < 3) {
        return Math.round(base * Math.pow(2, upgrades));
      } else if (upgrades < 6) {
        return Math.round(base * 8 * Math.pow(2.5, upgrades - 3));
      } else if (upgrades < 9) {
        return Math.round(base * 8 * 15.625 * Math.pow(4, upgrades - 6));
      } else {
        const costAt9 = base * 8 * 15.625 * 64; // 80000
        return Math.round(costAt9 * Math.pow(3, upgrades - 9));
      }
    }

    function getAutoClickerCost(level) {
      const base = 50;
      return Math.round(base * Math.pow(1.8, level));
    }

    function updateUI() {
      document.getElementById("score").innerText = player.score;
      document.getElementById("energy").innerText = Math.floor(player.energy);
      document.getElementById("regenCost").innerText = getEnergyRegenCost(player.energyUpgrades);
      document.getElementById("autoClickerCost").innerText = getAutoClickerCost(player.autoClickerLevel);
      document.getElementById("autoClickerLevel").innerText = player.autoClickerLevel;
      const percent = (player.energy / player.maxEnergy) * 100;
      document.getElementById("energyFill").style.width = percent + "%";
    }

    function showMessage(msg, success = true) {
      const div = document.createElement("div");
      div.className = `status status-${success ? 'success' : 'error'}`;
      div.innerText = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    async function savePlayerData() {
      if (!player.id || !player.isInitialized) return false;
      try {
        const params = new URLSearchParams({
          action: "updateScore",
          id: player.id,
          name: player.name,
          score: player.score,
          energy: player.energy,
          energyRegen: player.energyRegen,
          energyUpgrades: player.energyUpgrades,
          autoClickerLevel: player.autoClickerLevel
        });
        const url = `${apiUrl}?${params}&_=${Date.now()}`;
        const img = new Image();
        img.src = url;
        return true;
      } catch (e) {
        console.error("Save failed", e);
        return false;
      }
    }

    async function loadPlayerData() {
      if (!player.id) return;

      try {
        const url = `${apiUrl}?action=getPlayer&id=${player.id}&name=${encodeURIComponent(player.name)}&_=${Date.now()}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
          player.score = data.found ? (parseInt(data.score) || 0) : 0;
          player.energy = data.found ? (parseFloat(data.energy) || 100) : 100;
          player.energyRegen = data.found ? (parseInt(data.energyRegen) || 1) : 1;
          player.energyUpgrades = data.found ? (parseInt(data.energyUpgrades) || 0) : 0;
          player.autoClickerLevel = data.found ? (parseInt(data.autoClickerLevel) || 0) : 0;

          // Офлайн-восстановление
          if (data.found && data.lastOnline) {
            const offlineSec = Math.min(86400, Math.floor((Date.now() - new Date(data.lastOnline)) / 1000));
            player.energy = Math.min(650, player.energy + offlineSec * player.energyRegen);
          }

          player.isInitialized = true;
          updateUI();
          showMessage(data.found ? '✅ Добро пожаловать обратно!' : '🆕 Новая игра!');
        }
      } catch (e) {
        console.error("Load error", e);
        player.isInitialized = true;
        updateUI();
        showMessage("⚠️ Офлайн-режим", false);
      }
    }

    function buyEnergyRegen() {
      const cost = getEnergyRegenCost(player.energyUpgrades);
      if (player.score >= cost) {
        player.score -= cost;
        player.energyUpgrades++;
        player.energyRegen++;
        updateUI();
        savePlayerData();
      } else {
        showMessage("❌ Недостаточно очков!", false);
      }
    }

    function buyAutoClicker() {
      const cost = getAutoClickerCost(player.autoClickerLevel);
      if (player.score >= cost) {
        player.score -= cost;
        player.autoClickerLevel++;
        updateUI();
        savePlayerData();
      } else {
        showMessage("❌ Недостаточно очков для автокликера!", false);
      }
    }

    function simulateTelegram() {
      player.id = Math.floor(Math.random() * 1000000);
      player.name = "Тест";
      document.getElementById('authMessage').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById("user").innerText = `Привет, ${player.name}! (Тест)`;
      player.isInitialized = true;
      updateUI();
    }

    function initTelegramGame() {
      if (tg?.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        player.id = user.id;
        player.name = user.first_name || 'Игрок';

        tg.expand();
        document.getElementById('authMessage').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.getElementById("user").innerText = `Привет, ${player.name}!`;

        loadPlayerData();
      } else {
        showMessage("Запустите из Telegram!", false);
      }
    }

    document.getElementById("clickBtn").addEventListener("click", () => {
      if (player.energy >= 5) {
        player.energy -= 5;
        player.score++;
        updateUI();
        if (player.score % 5 === 0) savePlayerData();
      } else {
        showMessage("⚡ Нет энергии!", false);
      }
    });

    // Восстановление энергии каждую секунду
    setInterval(() => {
      if (player.energy < 650 && player.isInitialized) {
        player.energy = Math.min(650, player.energy + player.energyRegen);
        updateUI();
      }
    }, 1000);

// Автокликер (без траты энергии)
setInterval(() => {
  if (player.isInitialized && player.autoClickerLevel > 0) {
    // Просто добавляем очки — энергия НЕ тратится
    player.score += player.autoClickerLevel;
    updateUI();
    if (player.score % 10 === 0) savePlayerData();
  }
}, 1000);

    // Автосохранение
    setInterval(() => {
      if (player.isInitialized) savePlayerData();
    }, 30000);

    window.forceSave = () => savePlayerData().then(ok => showMessage(ok ? "✅ Сохранено!" : "❌ Ошибка", ok));

    document.addEventListener('DOMContentLoaded', initTelegramGame);
  </script>
</body>
</html>