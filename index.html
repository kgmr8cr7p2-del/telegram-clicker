<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>🎮 CS2 Кликер + Gallery Case</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      cursor: default;
      touch-action: manipulation;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 15px;
    }
    .container {
      text-align: center;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #4fc3f7;
    }
    .score {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: gold;
    }
    .mining-rate {
      font-size: 16px;
      margin: 8px 0;
      color: #aaffaa;
    }
    .case-count {
      font-size: 16px;
      margin: 8px 0;
      color: #aaffaa;
    }
    .click-btn,
    .open-case-btn,
    .inv-btn,
    .upgrade-miner-btn {
      width: 120px;
      height: 120px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin: 12px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease;
    }
    .click-btn {
      background: linear-gradient(135deg, #ff9a00, #ff5200);
      box-shadow: 0 6px 18px rgba(255, 82, 0, 0.4);
    }
    .open-case-btn {
      background: linear-gradient(135deg, #00b09b, #96c93d);
      box-shadow: 0 6px 18px rgba(0, 176, 155, 0.4);
    }
    .open-case-btn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .inv-btn {
      background: linear-gradient(135deg, #6a00ff, #b027ff);
      box-shadow: 0 6px 18px rgba(106, 0, 255, 0.4);
      width: auto;
      padding: 8px 20px;
      border-radius: 12px;
      font-size: 14px;
    }
    .upgrade-miner-btn {
      background: linear-gradient(135deg, #ff6f00, #ff8f00);
      box-shadow: 0 6px 18px rgba(255, 111, 0, 0.4);
      width: auto;
      padding: 8px 20px;
      border-radius: 12px;
      font-size: 14px;
    }
    .click-btn:active,
    .open-case-btn:active,
    .inv-btn:active,
    .upgrade-miner-btn:active {
      transform: scale(0.94);
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #aaffaa;
    }
    /* РУЛЕТКА */
    .roulette-wrapper {
      position: relative;
      width: 100%;
      margin: 15px 0;
    }
    .roulette-arrow {
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.9);
      z-index: 20;
      pointer-events: none;
    }
    .roulette-container {
      width: 100%;
      height: 120px;
      overflow: hidden;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.25);
    }
    .roulette-track {
      display: flex;
      align-items: center;
      height: 120px;
      transition: transform 0.1s linear;
    }
    .skin-item {
      min-width: 90px;
      height: 100px;
      margin: 0 6px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 4px;
      font-size: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
    }
    .skin-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 4px;
      border-radius: 4px;
    }
    .highlight {
      transform: scale(1.15);
      box-shadow: 0 0 16px gold;
      z-index: 10;
      position: relative;
    }
    /* ИНВЕНТАРЬ */
    .inventory-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      padding: 20px;
      overflow-y: auto;
    }
    .inventory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .inventory-title {
      color: white;
      font-size: 20px;
    }
    .close-inv {
      background: #ff4d4d;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
    }
    .inv-item {
      background: rgba(30, 30, 40, 0.7);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 14px;
      text-align: left;
      border-left: 4px solid #4b69ff;
      display: flex;
      align-items: center;
    }
    .inv-item.stattrak { border-left-color: gold; }
    .inv-item.souvenir { border-left-color: #00ffcc; }
    .inv-item img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 4px;
    }
    .inv-item-info {
      flex: 1;
    }
    .inv-item-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .inv-item-meta {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 4px;
    }
    .sell-btn {
      background: linear-gradient(135deg, #ff3366, #ff6600);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 6px;
      font-weight: bold;
      width: auto;
    }
    .sell-btn:active {
      transform: scale(0.96);
    }
    /* МОДАЛЬНОЕ ОКНО ВЫПАВШЕГО СКИНА */
    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 300;
      padding: 20px;
      justify-content: center;
      align-items: center;
    }
    .result-modal-content {
      background: rgba(20,20,30,0.95);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }
    .result-modal img {
      width: 100px;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
    }
    .result-modal-price {
      font-size: 18px;
      color: gold;
      margin: 8px 0;
    }
    .result-modal-btns {
      margin-top: 12px;
    }
    .result-keep-btn, .result-sell-btn {
      margin: 0 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    .result-keep-btn {
      background: #4caf50;
      color: white;
    }
    .result-sell-btn {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎮 CS2 Кликер + Gallery Case</h1>
    <div class="score">Очки: <span id="score">0</span></div>
    <div class="mining-rate">Майнинг: <span id="miningRate">0</span> в сек</div>
    <div class="case-count">Кейсов: <span id="caseCount">0</span></div>
    <button class="click-btn" id="clickBtn">КЛИК!</button>
    <button class="open-case-btn" id="openCaseBtn" disabled>Открыть кейс</button>
    <button class="inv-btn" id="invBtn">Инвентарь</button>
    <button class="upgrade-miner-btn" id="upgradeMinerBtn">Улучшить Майнер (Цена: <span id="upgradeCost">10</span>)</button>
    <div class="status" id="status">Загрузка...</div>
    <div class="roulette-wrapper">
      <div class="roulette-arrow">▼</div>
      <div class="roulette-container">
        <div class="roulette-track" id="rouletteTrack"></div>
      </div>
    </div>
  </div>
  <!-- МОДАЛЬНОЕ ОКНО ВЫПАВШЕГО СКИНА -->
  <div class="result-modal" id="resultModal">
    <div class="result-modal-content">
      <h3>🎉 Выпал предмет!</h3>
      <div id="resultModalImg"></div>
      <div id="resultModalName" style="font-weight:bold; font-size:16px;"></div>
      <div id="resultModalQuality" style="color:#aaa;"></div>
      <div id="resultModalRarity" style="font-style:italic;"></div>
      <div id="resultModalMod" style="color:gold; margin:6px 0;"></div>
      <div class="result-modal-price">Цена: <span id="resultModalPrice">0</span> ₽</div>
      <div class="result-modal-btns">
        <button class="result-keep-btn" id="resultKeepBtn">Оставить</button>
        <button class="result-sell-btn" id="resultSellBtn">Продать</button>
      </div>
    </div>
  </div>
  <!-- ИНВЕНТАРЬ -->
  <div class="inventory-modal" id="invModal">
    <div class="inventory-header">
      <div class="inventory-title">🎒 Инвентарь</div>
      <button class="close-inv" id="closeInv">✕</button>
    </div>
    <div id="invList">Загрузка...</div>
  </div>
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxYqAq8vAlb8TFFB8GZoZAo9jwVQYL1LjHRCjTmiv8P0K9Tg9q8LMlYkNumXbfWlnfT/exec";
    const QUALITIES = [
      { name: "FN", fullName: "Прямо с завода", color: "#b0c3d9" },
      { name: "MW", fullName: "Немного поношенное", color: "#5e92f3" },
      { name: "FT", fullName: "После полевых испытаний", color: "#4b69ff" },
      { name: "WW", fullName: "Поношенное", color: "#8847ff" },
      { name: "BS", fullName: "Закалённое в боях", color: "#d32ce6" }
    ];
    const RARITIES = [
      { name: "Ширпотреб", color: "#b0c3d9" },
      { name: "Промышленное", color: "#5e92f3" },
      { name: "Армейское", color: "#4b69ff" },
      { name: "Запрещенное", color: "#8847ff" },
      { name: "Засекреченное", color: "#d32ce6" },
      { name: "Тайное", color: "#eb4b4b" },
      { name: "Нож", color: "#ffd700" }
    ];

    function getWeightedRandomWeapon(weapons) {
      const totalWeight = weapons.reduce((sum, w) => sum + (w.weight || 1), 0);
      let random = Math.random() * totalWeight;
      for (const weapon of weapons) {
        random -= weapon.weight || 1;
        if (random <= 0) return weapon;
      }
      return weapons[0];
    }

    const CASES = [ /* ...ваш массив CASES без изменений... */ ];

    let player = {
      id: null,
      name: "Гость",
      score: 0,
      miningRate: 0,
      minerLevel: 0,        // ← Уровень майнера
      miningFraction: 0,    // ← для целых очков онлайн
      lastActive: Date.now(),
      caseProgress: 0,
      cases: [],
      isLoaded: false,
      inventory: []
    };

    let isSpinning = false;
    let isMiningActive = true;
    let miningIntervalId = null;

    const scoreEl = document.getElementById('score');
    const miningRateEl = document.getElementById('miningRate');
    const caseCountEl = document.getElementById('caseCount');
    const statusEl = document.getElementById('status');
    const clickBtn = document.getElementById('clickBtn');
    const openCaseBtn = document.getElementById('openCaseBtn');
    const invBtn = document.getElementById('invBtn');
    const upgradeMinerBtn = document.getElementById('upgradeMinerBtn');
    const upgradeCostEl = document.getElementById('upgradeCost');
    const invModal = document.getElementById('invModal');
    const invList = document.getElementById('invList');
    const closeInv = document.getElementById('closeInv');
    const rouletteTrack = document.getElementById('rouletteTrack');
    const resultModal = document.getElementById('resultModal');
    const resultModalImg = document.getElementById('resultModalImg');
    const resultModalName = document.getElementById('resultModalName');
    const resultModalQuality = document.getElementById('resultModalQuality');
    const resultModalRarity = document.getElementById('resultModalRarity');
    const resultModalMod = document.getElementById('resultModalMod');
    const resultModalPrice = document.getElementById('resultModalPrice');
    const resultSellBtn = document.getElementById('resultSellBtn');
    const resultKeepBtn = document.getElementById('resultKeepBtn');

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? '#ff9999' : '#aaffaa';
    }

    // 🔢 Расчёт стоимости улучшения по уровню
    function getUpgradeCost(level) {
      return Math.floor(10 * Math.pow(1.5, level));
    }

    // 💾 Сохранение (без lastActive!)
    function savePlayerData() {
      if (!player.id || !player.isLoaded) return;
      const params = new URLSearchParams({
        action: "updatePlayer",
        id: player.id,
        score: player.score,
        miningRate: player.miningRate,
        minerLevel: player.minerLevel,
        miningFraction: player.miningFraction,
        caseProgress: player.caseProgress,
        cases: JSON.stringify(player.cases)
      });
      fetch(`${GAS_URL}?${params}&_=${Date.now()}`).catch(err => console.error("Ошибка сохранения:", err));

      const params2 = new URLSearchParams({
        action: "updateInventory",
        id: player.id,
        inventory: JSON.stringify(player.inventory)
      });
      fetch(`${GAS_URL}?${params2}&_=${Date.now()}`).catch(err => console.error("Ошибка сохранения инвентаря:", err));
    }

    // 💾 При уходе — фиксируем lastActive
    function saveOnExit() {
      if (!player.id || !player.isLoaded) return;
      player.lastActive = Date.now();
      const params = new URLSearchParams({
        action: "updatePlayer",
        id: player.id,
        score: player.score,
        miningRate: player.miningRate,
        minerLevel: player.minerLevel,
        miningFraction: player.miningFraction,
        lastActive: player.lastActive,
        caseProgress: player.caseProgress,
        cases: JSON.stringify(player.cases)
      });
      if (navigator.sendBeacon) {
        navigator.sendBeacon(GAS_URL, params);
      } else {
        fetch(GAS_URL, { method: 'POST', body: params, keepalive: true });
      }
    }

    // 📥 Загрузка
    async function loadPlayerFromGAS() {
      const url = `${GAS_URL}?action=getPlayer&id=${encodeURIComponent(player.id)}&name=${encodeURIComponent(player.name)}&_=${Date.now()}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.success) {
        player.score = data.found ? (parseInt(data.score) || 0) : 0;
        player.miningRate = data.miningRate || 0;
        player.minerLevel = data.minerLevel || 0;
        player.miningFraction = data.miningFraction || 0;

        let lastActive = data.lastActive ? parseInt(data.lastActive) : Date.now();
        // Защита от битых дат
        if (lastActive < 1000000000000 || lastActive > Date.now() + 86400000) {
          lastActive = Date.now();
        }
        player.lastActive = lastActive;

        player.caseProgress = data.caseProgress || 0;
        player.cases = data.cases ? JSON.parse(data.cases) : [];
        player.inventory = data.inventory ? JSON.parse(data.inventory) : [];
        player.isLoaded = true;

        // 🧮 Офлайн-доход
        const now = Date.now();
        const timeOffline = (now - player.lastActive) / 1000;
        const offlineEarnings = Math.floor(player.miningRate * timeOffline);
        if (offlineEarnings > 0) {
          player.score += offlineEarnings;
          setStatus(`временно отсутствовали, мы добыли ${offlineEarnings} монет!`);
        }
        player.lastActive = now;
        savePlayerData();
        updateUI();
        return true;
      }
      throw new Error("GAS error");
    }

    // 🖥️ Обновление интерфейса
    function updateUI() {
      if (!player.isLoaded) return;
      scoreEl.textContent = Math.floor(player.score);
      miningRateEl.textContent = player.miningRate;
      caseCountEl.textContent = player.cases.length;
      upgradeCostEl.textContent = getUpgradeCost(player.minerLevel); // ← ключевое
      openCaseBtn.disabled = (player.cases.length === 0 || player.score < 10);
    }

    // ⛏️ Майнинг (целые очки)
    function processMining() {
      if (!isMiningActive) return;
      player.miningFraction += player.miningRate / 10;
      if (player.miningFraction >= 1) {
        const whole = Math.floor(player.miningFraction);
        player.score += whole;
        player.miningFraction -= whole;
      }
      updateUI();
    }

    // 🔼 Улучшение
    function upgradeMiner() {
      const currentCost = getUpgradeCost(player.minerLevel);
      if (player.score < currentCost) {
        setStatus("Недостаточно монет для улучшения!", true);
        return;
      }
      player.score -= currentCost;
      player.miningRate += 1;
      player.minerLevel += 1;
      savePlayerData();
      updateUI();
      setStatus(`Майнер улучшен! Скорость: ${player.miningRate}/сек`);
    }

    // --- ОСТАЛЬНЫЕ ФУНКЦИИ (без изменений) ---
    // (giveRandomCase, openCase, getWeightedQuality, getPrice, generateSkinItem, generateCaseSkins, renderRoulette, renderInventory)

    function getWeightedQuality(weapon, isStatTrak) {
      const weightsSource = weapon.qualityWeights;
      if (!weightsSource) {
        const defaultQual = QUALITIES.find(q => q.name === "BS") || { name: "BS", fullName: "Закалённое в боях", color: "#d32ce6" };
        return defaultQual;
      }
      const weights = isStatTrak ? weightsSource.statTrak : weightsSource.base;
      if (!weights) {
        const defaultQual = QUALITIES.find(q => q.name === "BS") || { name: "BS", fullName: "Закалённое в боях", color: "#d32ce6" };
        return defaultQual;
      }
      const qualities = Object.keys(weights);
      if (qualities.length === 0) {
        const defaultQual = QUALITIES.find(q => q.name === "BS") || { name: "BS", fullName: "Закалённое в боях", color: "#d32ce6" };
        return defaultQual;
      }
      const total = qualities.reduce((sum, q) => sum + weights[q], 0);
      let rand = Math.random() * total;
      for (const q of qualities) {
        rand -= weights[q];
        if (rand <= 0) {
          return {
            name: q,
            fullName: QUALITIES.find(qual => qual.name === q)?.fullName || q,
            color: QUALITIES.find(qual => qual.name === q)?.color || "#fff"
          };
        }
      }
      const lastQualName = qualities[qualities.length - 1];
      return {
        name: lastQualName,
        fullName: QUALITIES.find(qual => qual.name === lastQualName)?.fullName || lastQualName,
        color: QUALITIES.find(qual => qual.name === lastQualName)?.color || "#fff"
      };
    }

    function getPrice(weapon, qualityName, isStatTrak) {
      return isStatTrak
        ? weapon.prices.statTrak[qualityName]
        : weapon.prices.base[qualityName];
    }

    function generateSkinItem(weapon, quality, rarity, statTrak = false, souvenir = false) {
      const el = document.createElement('div');
      el.className = 'skin-item';
      el.style.backgroundColor = rarity.color + '30';
      if (weapon.img) {
        el.innerHTML = `<img src="${weapon.img}" alt="${weapon.name}">`;
      } else {
        el.innerHTML = `<div style="width:60px;height:60px;background:rgba(255,255,255,0.1);border-radius:4px;"></div>`;
      }
      if (statTrak) el.style.borderTop = '2px solid gold';
      if (souvenir) el.style.borderBottom = '2px solid #00ffcc';
      return el;
    }

    function generateCaseSkins(caseType, count) {
      const skins = [];
      for (let i = 0; i < count; i++) {
        const weapon = getWeightedRandomWeapon(caseType.weapons);
        const rarity = RARITIES[weapon.rarity];
        const statTrak = weapon.canBeStatTrak ? (Math.random() < 0.10) : false;
        const quality = getWeightedQuality(weapon, statTrak);
        const souvenir = false;
        skins.push({ weapon, quality, rarity, statTrak, souvenir });
      }
      return skins;
    }

    function renderRoulette(skins) {
      rouletteTrack.innerHTML = '';
      skins.forEach(skin => {
        const el = generateSkinItem(skin.weapon, skin.quality, skin.rarity, skin.statTrak, skin.souvenir);
        rouletteTrack.appendChild(el);
      });
    }

    function openCase() {
      if (player.cases.length === 0 || player.score < 10) return;
      const caseName = player.cases.pop();
      const caseType = CASES.find(c => c.name === caseName);
      if (!caseType) return;
      player.score -= 10;
      updateUI();
      savePlayerData();
      setStatus("Крутим...");
      const preSpin = generateCaseSkins(caseType, 30);
      const weapon = getWeightedRandomWeapon(caseType.weapons);
      const statTrak = weapon.canBeStatTrak ? (Math.random() < 0.10) : false;
      const quality = getWeightedQuality(weapon, statTrak);
      const rarity = RARITIES[weapon.rarity];
      const price = getPrice(weapon, quality.name, statTrak);
      const postSpin = generateCaseSkins(caseType, 15);
      const fullList = [...preSpin, {weapon, quality, rarity, statTrak, price}, ...postSpin];
      renderRoulette(fullList);
      setTimeout(() => {
        const itemWidth = 102;
        const winIndex = preSpin.length;
        const containerWidth = document.querySelector('.roulette-container').offsetWidth;
        const targetCenter = winIndex * itemWidth + itemWidth / 2;
        const scrollLeft = targetCenter - containerWidth / 2;
        rouletteTrack.style.transition = 'none';
        rouletteTrack.style.transform = 'translateX(0)';
        void rouletteTrack.offsetWidth;
        rouletteTrack.style.transition = 'transform 3s ease-out';
        rouletteTrack.style.transform = `translateX(${-scrollLeft}px)`;
        setTimeout(() => {
          isSpinning = false;
          const items = rouletteTrack.querySelectorAll('.skin-item');
          items.forEach(el => el.classList.remove('highlight'));
          if (items[winIndex]) items[winIndex].classList.add('highlight');
          if (weapon.img) {
            resultModalImg.innerHTML = `<img src="${weapon.img}" alt="${weapon.name}">`;
          } else {
            resultModalImg.innerHTML = '';
          }
          resultModalName.textContent = weapon.name;
          resultModalQuality.textContent = quality.fullName;
          resultModalQuality.style.color = quality.color;
          resultModalRarity.textContent = RARITIES[weapon.rarity].name;
          resultModalRarity.style.color = RARITIES[weapon.rarity].color;
          const mods = [];
          if (statTrak) mods.push("StatTrak™");
          resultModalMod.textContent = mods.join(" | ");
          resultModalMod.style.display = mods.length ? 'block' : 'none';
          resultModalPrice.textContent = price;
          resultModal.style.display = 'flex';

          resultSellBtn.onclick = () => {
            player.score += price;
            updateUI();
            savePlayerData();
            resultModal.style.display = 'none';
            setStatus(`✅ +${price} ₽!`);
          };
          resultKeepBtn.onclick = () => {
            const newItem = {
              id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
              weapon: weapon.name,
              quality: quality.name,
              qualityFullName: quality.fullName,
              rarity: RARITIES[weapon.rarity].name,
              statTrak: statTrak,
              souvenir: false,
              price: price,
              img: weapon.img,
              timestamp: Date.now()
            };
            player.inventory.push(newItem);
            savePlayerData();
            resultModal.style.display = 'none';
            setStatus("✅ Предмет сохранён в инвентарь!");
          };
        }, 3100);
      }, 100);
    }

    function giveRandomCase() {
      player.cases = [];
      const caseType = CASES[Math.floor(Math.random() * CASES.length)];
      player.cases.push(caseType.name);
      setStatus(`🎁 Получен ${caseType.name}!`);
      updateUI();
      savePlayerData();
    }

    function renderInventory() {
      if (!player.isLoaded) {
        invList.innerHTML = "Загрузка...";
        return;
      }
      if (player.inventory.length === 0) {
        invList.innerHTML = '<div style="color:#aaa; font-style:italic; text-align:center; padding:20px;">Пусто</div>';
        return;
      }
      const sorted = [...player.inventory].sort((a, b) => b.timestamp - a.timestamp);
      let html = '';
      sorted.forEach((item, index) => {
        let mods = [];
        if (item.statTrak) mods.push("StatTrak™");
        const modText = mods.length ? ` (${mods.join(" | ")})` : '';
        html += `
          <div class="inv-item ${item.statTrak ? 'stattrak' : ''}">
            ${item.img ? `<img src="${item.img}" alt="${item.weapon}">` : ''}
            <div class="inv-item-info">
              <div class="inv-item-name">${item.weapon}</div>
              <div class="inv-item-meta">${item.qualityFullName} • ${item.rarity}${modText}</div>
              <div style="font-size:13px; color:gold;">💰 Цена: ${item.price} ₽</div>
              <button class="sell-btn" data-index="${index}">Продать</button>
            </div>
          </div>
        `;
      });
      invList.innerHTML = html;
      document.querySelectorAll('.sell-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          const item = player.inventory[index];
          if (!item) return;
          if (confirm(`Продать ${item.weapon} за ${item.price} ₽?`)) {
            player.score += item.price;
            player.inventory.splice(index, 1);
            updateUI();
            savePlayerData();
            renderInventory();
            setStatus(`✅ +${item.price} ₽!`);
          }
        });
      });
    }

    // === ИНИЦИАЛИЗАЦИЯ ===
    (async () => {
      const tg = window.Telegram?.WebApp;
      if (tg?.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        player.id = String(user.id);
        player.name = user.username
          ? '@' + user.username
          : (user.first_name || "Игрок") + (user.last_name ? " " + user.last_name : "");
        try { tg.expand(); } catch (e) {}
        setStatus("Подключение...");
        try {
          await loadPlayerFromGAS();
          setStatus("✅ Готово");
        } catch (e) {
          console.error("GAS load failed", e);
          player.isLoaded = true;
          player.inventory = [];
          player.lastActive = Date.now();
          setStatus("⚠️ Офлайн-режим", true);
        }
      } else {
        player.id = "test_" + Math.floor(Math.random() * 1000000);
        player.name = "Тест";
        player.isLoaded = true;
        player.inventory = [];
        player.lastActive = Date.now();
        setStatus("🧪 Тестовый режим", true);
      }

      updateUI();
      renderRoulette(generateCaseSkins(CASES[0], 25));

      miningIntervalId = setInterval(processMining, 100);

      clickBtn.addEventListener('click', () => {
        player.score += 1;
        updateUI();
        if (player.cases.length === 0) {
          player.caseProgress += 1;
          if (player.caseProgress >= 20) {
            player.caseProgress = 0;
            giveRandomCase();
          }
        }
        if (player.score % 5 === 0) savePlayerData();
      });

      openCaseBtn.addEventListener('click', openCase);
      invBtn.addEventListener('click', () => {
        renderInventory();
        invModal.style.display = 'block';
      });
      closeInv.addEventListener('click', () => {
        invModal.style.display = 'none';
      });
      upgradeMinerBtn.addEventListener('click', upgradeMiner);

      // 🔑 Ключевое: сохранение при уходе
      window.addEventListener('beforeunload', saveOnExit);
      window.addEventListener('pagehide', saveOnExit); // для Telegram Mini Apps

      setInterval(savePlayerData, 10000);
    })();
  </script>
</body>
</html>