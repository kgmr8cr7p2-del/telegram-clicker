<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>🎮 CS2 Кликер + Инвентарь</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      cursor: default;
      touch-action: manipulation;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 15px;
    }

    .container {
      text-align: center;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .score {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }

    .click-btn,
    .case-btn,
    .inv-btn {
      width: 120px;
      height: 120px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin: 12px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease;
    }

    .click-btn {
      background: linear-gradient(135deg, #ff9a00, #ff5200);
      box-shadow: 0 6px 18px rgba(255, 82, 0, 0.4);
    }

    .case-btn {
      background: linear-gradient(135deg, #00b09b, #96c93d);
      box-shadow: 0 6px 18px rgba(0, 176, 155, 0.4);
    }

    .inv-btn {
      background: linear-gradient(135deg, #6a00ff, #b027ff);
      box-shadow: 0 6px 18px rgba(106, 0, 255, 0.4);
      width: auto;
      padding: 8px 20px;
      border-radius: 12px;
      font-size: 14px;
    }

    .click-btn:active,
    .case-btn:active,
    .inv-btn:active {
      transform: scale(0.94);
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #aaffaa;
    }

    /* РУЛЕТКА */
    .roulette-wrapper {
      position: relative;
      width: 100%;
      margin: 15px 0;
    }

    .roulette-arrow {
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.9);
      z-index: 20;
      pointer-events: none;
    }

    .roulette-container {
      width: 100%;
      height: 100px;
      overflow: hidden;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
    }

    .roulette-track {
      display: flex;
      align-items: center;
      height: 100px;
      transition: transform 0.1s linear;
    }

    .skin-item {
      min-width: 80px;
      height: 80px;
      margin: 0 4px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 4px;
      font-size: 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      text-align: center;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .skin-quality {
      font-size: 8px;
      opacity: 0.7;
      margin-top: 2px;
    }

    .highlight {
      transform: scale(1.12);
      box-shadow: 0 0 16px gold;
      z-index: 10;
      position: relative;
    }

    /* РЕЗУЛЬТАТ */
    .result-box {
      margin-top: 15px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      display: none;
    }

    .result-name { font-weight: bold; font-size: 16px; }
    .result-quality { font-size: 13px; margin-top: 3px; }
    .result-rarity { font-size: 13px; margin-top: 2px; font-style: italic; }
    .result-mod { font-size: 12px; margin-top: 3px; color: gold; }

    /* ИНВЕНТАРЬ */
    .inventory-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      padding: 20px;
      overflow-y: auto;
    }

    .inventory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .inventory-title {
      color: white;
      font-size: 20px;
    }

    .close-inv {
      background: #ff4d4d;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
    }

    .inv-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      text-align: left;
      border-left: 3px solid #4b69ff;
    }

    .inv-item.stattrak { border-left-color: gold; }
    .inv-item.souvenir { border-left-color: #00ffcc; }

    .inv-item-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 3px;
    }

    .inv-item-meta {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 4px;
    }

    .sell-btn {
      background: linear-gradient(135deg, #ff3366, #ff6600);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      margin-top: 4px;
      width: 100%;
      font-weight: bold;
    }

    .sell-btn:active {
      transform: scale(0.96);
    }

    /* МОДАЛЬНОЕ ОКНО ПРОДАЖИ */
    .sell-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 200;
      padding: 20px;
      justify-content: center;
      align-items: center;
    }

    .sell-content {
      background: rgba(30,30,50,0.9);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }

    .sell-price {
      font-size: 24px;
      font-weight: bold;
      color: gold;
      margin: 10px 0;
    }

    .sell-confirm-btn, .sell-cancel-btn {
      margin: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .sell-confirm-btn {
      background: #4caf50;
      color: white;
    }

    .sell-cancel-btn {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎮 CS2 Кликер + Инвентарь</h1>
    <div class="score">Очки: <span id="score">0</span></div>
    <button class="click-btn" id="clickBtn">КЛИК!</button>
    <button class="case-btn" id="caseBtn">Кейс (10)</button>
    <button class="inv-btn" id="invBtn">Инвентарь</button>
    <div class="status" id="status">Загрузка...</div>

    <div class="roulette-wrapper">
      <div class="roulette-arrow">▼</div>
      <div class="roulette-container">
        <div class="roulette-track" id="rouletteTrack"></div>
      </div>
    </div>

    <div class="result-box" id="resultBox">
      <div class="result-name" id="resultName">—</div>
      <div class="result-quality" id="resultQuality">—</div>
      <div class="result-rarity" id="resultRarity">—</div>
      <div class="result-mod" id="resultMod"></div>
    </div>
  </div>

  <!-- ИНВЕНТАРЬ -->
  <div class="inventory-modal" id="invModal">
    <div class="inventory-header">
      <div class="inventory-title">🎒 Инвентарь</div>
      <button class="close-inv" id="closeInv">✕</button>
    </div>
    <div id="invList">Загрузка...</div>
  </div>

  <!-- ПРОДАЖА -->
  <div class="sell-modal" id="sellModal">
    <div class="sell-content">
      <h3>💰 Продать предмет?</h3>
      <div id="sellItemName" style="font-weight:bold; margin:8px 0;"></div>
      <div>Вы получите:</div>
      <div class="sell-price" id="sellPrice">0 очков</div>
      <button class="sell-confirm-btn" id="sellConfirm">Продать</button>
      <button class="sell-cancel-btn" id="sellCancel">Отмена</button>
    </div>
  </div>

  <script>
    // ===== НАСТРОЙКИ =====
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzbNf-4nX4y7DV0unVOFsW8L2UX6wy3e1nPY75wpkrsbTDvAFnV4lZ4ruOTAo5QIRuf/exec";

    // ===== CS2 ДАННЫЕ =====
    const QUALITIES = [
      { name: "FN", fullName: "Прямо с завода", color: "#b0c3d9" },
      { name: "MW", fullName: "Немного поношенное", color: "#5e92f3" },
      { name: "FT", fullName: "После полевых испытаний", color: "#4b69ff" },
      { name: "WW", fullName: "Поношенное", color: "#8847ff" },
      { name: "BS", fullName: "Закалённое в боях", color: "#d32ce6" }
    ];

    const RARITIES = [
      { name: "Ширпотреб", color: "#b0c3d9" },
      { name: "Промышленное", color: "#5e92f3" },
      { name: "Армейское", color: "#4b69ff" },
      { name: "Запрещенное", color: "#8847ff" },
      { name: "Засекреченное", color: "#d32ce6" },
      { name: "Тайное", color: "#eb4b4b" }
    ];

    const WEAPONS = [
      { name: "P250 | Bone Mask", rarity: 0 },
      { name: "FAMAS | Djinn", rarity: 1 },
      { name: "AK-47 | Redline", rarity: 2 },
      { name: "M4A4 | Howl", rarity: 3 },
      { name: "Desert Eagle | Blaze", rarity: 4 },
      { name: "AWP | Dragon Lore", rarity: 5 },
      { name: "USP-S | Kill Confirmed", rarity: 2 },
      { name: "Glock-18 | Fade", rarity: 3 },
      { name: "XM1014 | Heaven Guard", rarity: 1 },
      { name: "Five-SeveN | Hyper Beast", rarity: 4 }
    ];

    // ===== ГЛОБАЛЬНЫЙ СОСТОЯНИЕ =====
    let player = {
      id: null,
      name: "Гость",
      score: 0,
      isLoaded: false,
      inventory: []
    };
    let isSpinning = false;
    let sellPendingIndex = -1;

    // ===== DOM =====
    const scoreEl = document.getElementById('score');
    const statusEl = document.getElementById('status');
    const clickBtn = document.getElementById('clickBtn');
    const caseBtn = document.getElementById('caseBtn');
    const invBtn = document.getElementById('invBtn');
    const invModal = document.getElementById('invModal');
    const invList = document.getElementById('invList');
    const closeInv = document.getElementById('closeInv');
    const rouletteTrack = document.getElementById('rouletteTrack');
    const resultBox = document.getElementById('resultBox');
    const resultName = document.getElementById('resultName');
    const resultQuality = document.getElementById('resultQuality');
    const resultRarity = document.getElementById('resultRarity');
    const resultMod = document.getElementById('resultMod');
    const sellModal = document.getElementById('sellModal');
    const sellConfirm = document.getElementById('sellConfirm');
    const sellCancel = document.getElementById('sellCancel');

    // ===== УТИЛИТЫ =====
    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? '#ff9999' : '#aaffaa';
    }

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function calculateItemPrice(weaponName, qualityFullName, rarityName, statTrak = false, souvenir = false) {
      const rarityValue = RARITIES.findIndex(r => r.name === rarityName);
      const qualityValue = QUALITIES.findIndex(q => q.fullName === qualityFullName);
      let base = (rarityValue + 1) * 10 + (qualityValue + 1) * 2;
      let bonus = 0;
      if (statTrak) bonus += 0.3;
      if (souvenir) bonus += 0.5;
      const withBonus = base * (1 + bonus);
      const randomFactor = 0.8 + Math.random() * 0.4;
      return Math.floor(withBonus * randomFactor);
    }

    function generateSkinItem(weapon, quality, rarity, statTrak = false, souvenir = false) {
      const el = document.createElement('div');
      el.className = 'skin-item';
      el.style.backgroundColor = rarity.color + '25';
      el.innerHTML = `<div>${weapon.name}</div><div class="skin-quality">${quality.name}</div>`;
      if (statTrak) el.style.borderTop = '2px solid gold';
      if (souvenir) el.style.borderBottom = '2px solid #00ffcc';
      return el;
    }

    function generateRouletteSkins(count = 50) {
      const skins = [];
      for (let i = 0; i < count; i++) {
        const weapon = WEAPONS[getRandomInt(0, WEAPONS.length - 1)];
        const rarity = RARITIES[weapon.rarity];
        const quality = QUALITIES[getRandomInt(0, QUALITIES.length - 1)];
        const statTrak = Math.random() < 0.08;
        const souvenir = !statTrak && Math.random() < 0.03;
        skins.push({ weapon, quality, rarity, statTrak, souvenir });
      }
      return skins;
    }

    function renderRoulette(skins) {
      rouletteTrack.innerHTML = '';
      skins.forEach(skin => {
        const el = generateSkinItem(skin.weapon, skin.quality, skin.rarity, skin.statTrak, skin.souvenir);
        rouletteTrack.appendChild(el);
      });
    }

    // ===== GAS =====
    async function loadPlayerFromGAS() {
      const url = `${GAS_URL}?action=getPlayer&id=${encodeURIComponent(player.id)}&name=${encodeURIComponent(player.name)}&_=${Date.now()}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.success) {
        player.score = data.found ? (parseInt(data.score) || 0) : 0;
        player.name = data.name || player.name;
        player.inventory = data.inventory ? JSON.parse(data.inventory) : [];
        player.isLoaded = true;
        return true;
      }
      throw new Error("GAS error");
    }

    function saveScoreToGAS() {
      if (!player.id || !player.isLoaded) return;
      const img = new Image();
      const params = new URLSearchParams({
        action: "updateScore",
        id: player.id,
        score: player.score
      });
      img.src = `${GAS_URL}?${params}&_=${Date.now()}`;
    }

    function saveInventoryToGAS() {
      if (!player.id || !player.isLoaded) return;
      const img = new Image();
      const params = new URLSearchParams({
        action: "updateInventory",
        id: player.id,
        inventory: JSON.stringify(player.inventory)
      });
      img.src = `${GAS_URL}?${params}&_=${Date.now()}`;
    }

    // ===== ИНВЕНТАРЬ =====
    function addItemToInventory(itemData) {
      const price = calculateItemPrice(
        itemData.weapon.name,
        itemData.quality.fullName,
        itemData.rarity.name,
        itemData.statTrak,
        itemData.souvenir
      );

      const newItem = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        weapon: itemData.weapon.name,
        quality: itemData.quality.name,
        qualityFullName: itemData.quality.fullName,
        rarity: itemData.rarity.name,
        statTrak: itemData.statTrak,
        souvenir: itemData.souvenir,
        price: price,
        timestamp: Date.now()
      };
      player.inventory.push(newItem);
      saveInventoryToGAS();
    }

    function renderInventory() {
      if (!player.isLoaded) {
        invList.innerHTML = "Загрузка...";
        return;
      }

      if (player.inventory.length === 0) {
        invList.innerHTML = '<div style="color:#aaa; font-style:italic; text-align:center; padding:20px;">Пусто</div>';
        return;
      }

      const sorted = [...player.inventory].sort((a, b) => b.timestamp - a.timestamp);
      let html = '';
      sorted.forEach((item, index) => {
        let mods = [];
        if (item.statTrak) mods.push("StatTrak™");
        if (item.souvenir) mods.push("Сувенир");
        const modText = mods.length ? ` (${mods.join(" | ")})` : '';

        html += `
          <div class="inv-item ${item.statTrak ? 'stattrak' : ''} ${item.souvenir ? 'souvenir' : ''}">
            <div class="inv-item-name">${item.weapon}</div>
            <div class="inv-item-meta">${item.qualityFullName} • ${item.rarity}${modText}</div>
            <div style="font-size:13px; color:gold; margin:4px 0;">💰 Цена: ${item.price} очков</div>
            <button class="sell-btn" data-index="${index}">Продать</button>
          </div>
        `;
      });
      invList.innerHTML = html;

      document.querySelectorAll('.sell-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          showSellModal(index);
        });
      });
    }

    function showSellModal(index) {
      const item = player.inventory[index];
      if (!item) return;

      sellPendingIndex = index;
      document.getElementById('sellItemName').textContent = item.weapon;
      document.getElementById('sellPrice').textContent = `${item.price} очков`;
      sellModal.style.display = 'flex';
    }

    // ===== РУЛЕТКА =====
    async function spinRoulette() {
      if (isSpinning || player.score < 10) {
        if (player.score < 10) setStatus("❌ Нужно 10 очков!");
        return;
      }

      isSpinning = true;
      player.score -= 10;
      scoreEl.textContent = player.score;
      saveScoreToGAS();
      setStatus("Крутим...");

      resultBox.style.display = 'none';

      const preSpin = generateRouletteSkins(30);
      const weapon = WEAPONS[getRandomInt(0, WEAPONS.length - 1)];
      const rarity = RARITIES[weapon.rarity];
      const quality = QUALITIES[getRandomInt(0, QUALITIES.length - 1)];
      const statTrak = Math.random() < 0.08;
      const souvenir = !statTrak && Math.random() < 0.03;
      const winSkin = { weapon, quality, rarity, statTrak, souvenir };
      const postSpin = generateRouletteSkins(15);
      const fullList = [...preSpin, winSkin, ...postSpin];
      renderRoulette(fullList);

      await new Promise(r => setTimeout(r, 50));

      const itemWidth = 88;
      const winIndex = preSpin.length;
      const containerWidth = document.querySelector('.roulette-container').offsetWidth;
      const targetCenter = winIndex * itemWidth + itemWidth / 2;
      const scrollLeft = targetCenter - containerWidth / 2;

      // 🔁 Фикс повторной анимации
      rouletteTrack.style.transition = 'none';
      rouletteTrack.style.transform = 'translateX(0)';
      rouletteTrack.offsetHeight; // reflow
      rouletteTrack.style.transition = 'transform 3s cubic-bezier(0.16, 1, 0.3, 1)';
      rouletteTrack.style.transform = `translateX(${-scrollLeft}px)`;

      setTimeout(() => {
        isSpinning = false;
        const items = rouletteTrack.querySelectorAll('.skin-item');
        items.forEach(el => el.classList.remove('highlight'));
        if (items[winIndex]) items[winIndex].classList.add('highlight');

        resultName.textContent = weapon.name;
        resultQuality.textContent = quality.fullName;
        resultQuality.style.color = quality.color;
        resultRarity.textContent = rarity.name;
        resultRarity.style.color = rarity.color;

        const mods = [];
        if (statTrak) mods.push("StatTrak™");
        if (souvenir) mods.push("Сувенир");
        resultMod.textContent = mods.join(" | ");
        resultMod.style.display = mods.length ? 'block' : 'none';
        resultBox.style.display = 'block';

        addItemToInventory(winSkin);
        setStatus("✅ Предмет сохранён!");
      }, 3100);
    }

    // ===== ИНИЦИАЛИЗАЦИЯ =====
    (async () => {
      const tg = window.Telegram?.WebApp;
	  if (tg?.initDataUnsafe?.user) {
		const user = tg.initDataUnsafe.user;
		player.id = String(user.id);
		// Используем username с @, если есть, иначе имя
		player.name = user.username 
		? '@' + user.username 
		: (user.first_name || "Игрок") + (user.last_name ? " " + user.last_name : "");
        try { tg.expand(); } catch (e) {}
        setStatus("Подключение...");
        try {
          await loadPlayerFromGAS();
          setStatus("✅ Готово");
        } catch (e) {
          console.error("GAS load failed", e);
          player.isLoaded = true;
          player.inventory = [];
          setStatus("⚠️ Офлайн-режим", true);
        }
      } else {
        player.id = "test_" + Math.floor(Math.random() * 1000000);
        player.name = "Тест";
        player.isLoaded = true;
        player.inventory = [];
        setStatus("🧪 Тестовый режим", true);
      }

      scoreEl.textContent = player.score;
      renderRoulette(generateRouletteSkins(25));

      clickBtn.addEventListener('click', () => {
        player.score += 1;
        scoreEl.textContent = player.score;
        if (player.score % 5 === 0) saveScoreToGAS();
      });

      caseBtn.addEventListener('click', spinRoulette);
      invBtn.addEventListener('click', () => {
        renderInventory();
        invModal.style.display = 'block';
      });
      closeInv.addEventListener('click', () => {
        invModal.style.display = 'none';
      });
      sellCancel.addEventListener('click', () => {
        sellModal.style.display = 'none';
        sellPendingIndex = -1;
      });
      sellConfirm.addEventListener('click', () => {
        if (sellPendingIndex === -1 || sellPendingIndex >= player.inventory.length) return;
        const item = player.inventory[sellPendingIndex];
        player.score += item.price;
        player.inventory.splice(sellPendingIndex, 1);
        scoreEl.textContent = player.score;
        saveScoreToGAS();
        saveInventoryToGAS();
        renderInventory();
        sellModal.style.display = 'none';
        sellPendingIndex = -1;
        setStatus(`✅ +${item.price} очков!`);
      });

      setInterval(() => {
        if (player.isLoaded) {
          saveScoreToGAS();
          saveInventoryToGAS();
        }
      }, 30000);
    })();
  </script>
</body>
</html>