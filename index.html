<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Кейс CS2 — Lamiz</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0f0c29, #302b63);
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: bold;
    }

    .case-header {
      margin-bottom: 16px;
      font-size: 22px;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(0, 200, 255, 0.7);
    }

    .spin-btn {
      padding: 14px 32px;
      font-size: 18px;
      background: linear-gradient(135deg, #00c9ff, #0072ff);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 130, 255, 0.6);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .spin-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .spin-btn:hover:not(:disabled) {
      transform: scale(1.04);
      box-shadow: 0 6px 20px rgba(0, 130, 255, 0.8);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      padding: 24px;
      border-radius: 20px;
      width: 90%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0, 200, 255, 0.6);
    }

    .modal-title {
      font-size: 22px;
      margin-bottom: 18px;
      color: #00eeff;
      font-weight: bold;
    }

    .prize-preview {
      width: 110px;
      height: 110px;
      margin: 0 auto 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      padding: 6px;
      text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    }

    .prize-name {
      font-size: 17px;
      font-weight: bold;
      margin: 8px 0 6px;
      color: white;
    }

    .prize-wear {
      font-size: 13px;
      color: #aaa;
      margin-bottom: 18px;
    }

    .modal-btns {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
      flex: 1;
      min-width: 90px;
    }

    .btn-info { background: #4a90e2; color: white; }
    .btn-sell { background: #e74c3c; color: white; }
    .btn-keep { background: #2ecc71; color: white; }

    .btn:hover {
      opacity: 0.92;
      transform: translateY(-2px);
    }

    .info-popup {
      margin-top: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 12px;
      font-size: 13px;
      color: #e0e0ff;
      line-height: 1.5;
      text-align: left;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .info-popup.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .info-row {
      margin: 5px 0;
    }

    .info-label {
      font-weight: bold;
      color: #66ccff;
    }

    .info-value {
      color: #fff;
    }

    .rarity-common       { background: #b0c3d9; color: #000; }
    .rarity-industrial   { background: #5e9dc6; color: #fff; }
    .rarity-mil-spec     { background: #4b69ff; color: #fff; }
    .rarity-restricted   { background: #8847ff; color: #fff; }
    .rarity-classified   { background: #d32ce6; color: #fff; }
    .rarity-covert       { background: #eb4b4b; color: #fff; }
    .rarity-rare         { background: #ffd700; color: #000; }
  </style>
</head>
<body>
  <div class="header">
    <div class="stats">
      <div>Очки: <span id="scoreDisplay">0</span></div>
      <div>⭐ Звёзды: <span id="starsDisplay">0</span></div>
    </div>
    <div class="case-header">Открой кейс за 1 ⭐</div>
  </div>
  <button class="spin-btn" id="spinBtn">Открыть кейс</button>

  <div class="modal" id="resultModal">
    <div class="modal-content">
      <div class="modal-title">🎉 Поздравляем!</div>
      <div class="prize-preview" id="prizePreview"></div>
      <div class="prize-name" id="prizeName"></div>
      <div class="prize-wear" id="prizeWear"></div>
      <div class="info-popup" id="infoPopup"></div>
      <div class="modal-btns">
        <button class="btn btn-info" id="infoBtn">ℹ️ Info</button>
        <button class="btn btn-sell" id="sellBtn">💰 Продать</button>
        <button class="btn btn-keep" id="keepBtn">🎒 Оставить</button>
      </div>
    </div>
  </div>

  <script>
    // ⚠️ ЗАМЕНИ ЭТОТ URL НА СВОЙ ИЗ GOOGLE APPS SCRIPT!
    const GAS_URL = "https://script.google.com/macros/s/AKfycby4uf9S7X_vUGWfDQRf3EeY58AGyXkiNwC9XxSfBN1hqoXPxOI-1WQc5gfguNMhcBAU/exec";
    const CASE_COST_STARS = 1;

    const RARITY_CLASSES = {
      common: "rarity-common",
      industrial: "rarity-industrial",
      "mil-spec": "rarity-mil-spec",
      restricted: "rarity-restricted",
      classified: "rarity-classified",
      covert: "rarity-covert",
      rare: "rarity-rare"
    };

    const RARITY_NAMES = {
      common: "Ширпотреб",
      industrial: "Промышленное качество",
      "mil-spec": "Армейское качество",
      restricted: "Запрещённое",
      classified: "Засекреченное",
      covert: "Тайное",
      rare: "Редкое"
    };

    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    const player = {
      id: tg?.initDataUnsafe?.user?.id || 'guest_' + Math.floor(Math.random() * 10000),
      stars: 0,
      score: 0
    };

    const spinBtn = document.getElementById('spinBtn');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const starsDisplay = document.getElementById('starsDisplay');
    const modal = document.getElementById('resultModal');
    const prizePreview = document.getElementById('prizePreview');
    const prizeName = document.getElementById('prizeName');
    const prizeWear = document.getElementById('prizeWear');
    const infoPopup = document.getElementById('infoPopup');
    const infoBtn = document.getElementById('infoBtn');
    const sellBtn = document.getElementById('sellBtn');
    const keepBtn = document.getElementById('keepBtn');

    let currentResult = null;

    function updateUI() {
      scoreDisplay.textContent = player.score;
      starsDisplay.textContent = player.stars;
      spinBtn.disabled = player.stars < CASE_COST_STARS;
    }

    async function fetchBalance() {
      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: player.id,
            action: "get_balance"
          })
        });
        const data = await res.json();
        if (data.success) {
          player.stars = data.stars;
          player.score = data.score;
          updateUI();
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        console.error("Balance error:", err);
        tg?.showAlert?.("Не удалось загрузить данные");
      }
    }

    async function openCase() {
      if (player.stars < CASE_COST_STARS) return;
      spinBtn.disabled = true;
      spinBtn.textContent = "Открываем...";

      try {
        const response = await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: player.id,
            action: "open_case"
          })
        });
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        currentResult = data.item;
        showResultModal();
        await fetchBalance();
      } catch (err) {
        tg?.showAlert?.("Ошибка: " + (err.message || "сервер"));
        console.error(err);
      } finally {
        spinBtn.textContent = "Открыть кейс";
        spinBtn.disabled = false;
      }
    }

    function showResultModal() {
      const item = currentResult;
      const cls = RARITY_CLASSES[item.rarity] || "rarity-common";
      const rarityName = RARITY_NAMES[item.rarity] || item.rarity;

      prizePreview.className = `prize-preview ${cls}`;
      prizePreview.textContent = item.name;
      prizeName.textContent = item.name;
      prizeWear.textContent = item.wear;

      window.currentItemForInfo = {
        name: item.name,
        rarity: rarityName,
        wear: item.wear,
        description: item.info || "Нет описания"
      };

      infoPopup.classList.remove('active');
      modal.classList.add('active');
    }

    async function handleUserChoice(action) {
      if (!currentResult) return;
      try {
        await fetch(GAS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: player.id,
            item_id: currentResult.id,
            action: action
          })
        });
        if (action === "sell") {
          const earned = Math.max(1, Math.floor(currentResult.base_price * 0.7));
          tg?.showAlert?.(`✅ Продано за ${earned} ⭐!`);
        } else {
          tg?.showAlert?.("✅ Сохранено!");
        }
        await fetchBalance();
      } catch (e) {
        tg?.showAlert?.("⚠️ Не удалось отправить");
      }
      modal.classList.remove('active');
    }

    spinBtn.addEventListener('click', openCase);
    infoBtn.addEventListener('click', () => {
      const item = window.currentItemForInfo;
      if (!item) return;
      infoPopup.innerHTML = `
        <div class="info-row"><span class="info-label">Название:</span> <span class="info-value">${item.name}</span></div>
        <div class="info-row"><span class="info-label">Редкость:</span> <span class="info-value">${item.rarity}</span></div>
        <div class="info-row"><span class="info-label">Качество:</span> <span class="info-value">${item.wear}</span></div>
        <div class="info-row" style="margin-top:10px;"><span class="info-label">Описание:</span></div>
        <div>${item.description}</div>
      `;
      infoPopup.classList.toggle('active');
    });
    sellBtn.addEventListener('click', () => handleUserChoice("sell"));
    keepBtn.addEventListener('click', () => handleUserChoice("keep"));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });

    fetchBalance();
  </script>
</body>
</html>